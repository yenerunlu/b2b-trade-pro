// /home/yunlu/b2b-app/controllers/b2bController.js - TAM GÃœNCELLEME
const sql = require('mssql');

class B2BController {
    constructor() {
        this.logoConfig = {
            server: '5.180.186.54',
            database: 'LOGOGO3',
            user: 'sa',
            password: 'Logo12345678',
            options: {
                encrypt: true,
                trustServerCertificate: true
            }
        };
        
        this.b2bConfig = {
            server: '5.180.186.54',
            database: 'B2B_TRADE_PRO',
            user: 'sa',
            password: 'Logo12345678',
            options: {
                encrypt: true,
                trustServerCertificate: true
            }
        };
        
        this.logoPool = null;
        this.b2bPool = null;
        this.startupTime = new Date();
    }

    // ====================================================
    // ğŸš€ 0. HELPER FONKSÄ°YONLAR
    // ====================================================
    decodeUserData(req) {
        try {
            const base64Data = req.headers['x-user-data-base64'];
            if (base64Data) {
                const decodedString = Buffer.from(base64Data, 'base64').toString('utf-8');
                return JSON.parse(decodedString);
            }
            
            const userData = req.headers['x-user-data'];
            if (userData) {
                return JSON.parse(userData);
            }
            
            return null;
        } catch (error) {
            console.error('âŒ KullanÄ±cÄ± verisi decode hatasÄ±:', error.message);
            return null;
        }
    }

    async healthCheck(req, res) {
        try {
            console.log('ğŸ¥ B2B Health check Ã§aÄŸrÄ±ldÄ±');
            
            let logoStatus = 'disconnected';
            try {
                const logoPool = await this.getLogoConnection();
                const logoResult = await logoPool.request().query('SELECT 1 as test');
                logoStatus = 'connected';
                console.log('âœ… Logo DB baÄŸlantÄ± testi baÅŸarÄ±lÄ±');
            } catch (logoError) {
                console.error('âŒ Logo DB baÄŸlantÄ± testi baÅŸarÄ±sÄ±z:', logoError.message);
            }
            
            let b2bStatus = 'disconnected';
            try {
                const b2bPool = await this.getB2BConnection();
                const b2bResult = await b2bPool.request().query('SELECT 1 as test');
                b2bStatus = 'connected';
                console.log('âœ… B2B DB baÄŸlantÄ± testi baÅŸarÄ±lÄ±');
            } catch (b2bError) {
                console.error('âŒ B2B DB baÄŸlantÄ± testi baÅŸarÄ±sÄ±z:', b2bError.message);
            }
            
            const isHealthy = logoStatus === 'connected' && b2bStatus === 'connected';
            
            res.json({
                success: true,
                data: {
                    status: isHealthy ? 'healthy' : 'degraded',
                    logo_database: logoStatus,
                    b2b_database: b2bStatus,
                    uptime_seconds: Math.floor((new Date() - this.startupTime) / 1000),
                    timestamp: new Date().toISOString(),
                    message: isHealthy ? 'B2B API saÄŸlÄ±klÄ± Ã§alÄ±ÅŸÄ±yor' : 'B2B API kÄ±sÄ±tlÄ± modda'
                }
            });
            
        } catch (error) {
            console.error('âŒ Health check hatasÄ±:', error.message);
            res.status(500).json({
                success: false,
                error: error.message,
                data: {
                    status: 'unhealthy',
                    logo_database: 'error',
                    b2b_database: 'error',
                    uptime_seconds: Math.floor((new Date() - this.startupTime) / 1000),
                    timestamp: new Date().toISOString(),
                    message: 'B2B API saÄŸlÄ±ksÄ±z durumda'
                }
            });
        }
    }
