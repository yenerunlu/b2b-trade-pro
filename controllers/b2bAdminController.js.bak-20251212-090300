// /home/yunlu/b2b-app/controllers/b2bAdminController.js - BASE64 DESTEKLƒ∞ G√úNCELLENMƒ∞≈û VERSƒ∞YON
const sql = require('mssql');
const b2bConfig = {
    server: '5.180.186.54',
    database: 'B2B_TRADE_PRO',
    user: 'sa',
    password: 'Logo12345678',
    options: {
        encrypt: true,
        trustServerCertificate: true,
        enableArithAbort: true
    },
    pool: {
        max: 10,
        min: 0,
        idleTimeoutMillis: 30000
    }
};

class B2BAdminController {
    constructor() {
        this.b2bConfig = b2bConfig || {
            server: '5.180.186.54',
            database: 'B2B_TRADE_PRO',
            user: 'sa',
            password: 'Logo12345678',
            options: {
                encrypt: true,
                trustServerCertificate: true,
                enableArithAbort: true
            },
            pool: {
                max: 10,
                min: 0,
                idleTimeoutMillis: 30000
            }
        };
        
        this.b2bPool = null;
        this.cache = new Map();
    }

    // ====================================================
    // üöÄ YENƒ∞: KULLANICI VERƒ∞Sƒ∞ DECODE HELPER
    // ====================================================
    decodeUserData(req) {
        try {
            const base64Data = req.headers['x-user-data-base64'];
            if (base64Data) {
                const decodedString = Buffer.from(base64Data, 'base64').toString('utf-8');
                const userData = JSON.parse(decodedString);
                console.log('‚úÖ Admin: Base64 kullanƒ±cƒ± verisi decode edildi');
                return userData;
            }
            
            const userData = req.headers['x-user-data'];
            if (userData) {
                const parsedData = JSON.parse(userData);
                console.log('‚úÖ Admin: Standart kullanƒ±cƒ± verisi parse edildi');
                return parsedData;
            }
            
            console.log('‚ö†Ô∏è Admin: Kullanƒ±cƒ± verisi header\'ƒ± bulunamadƒ±');
            return null;
            
        } catch (error) {
            console.error('‚ùå Admin kullanƒ±cƒ± verisi decode hatasƒ±:', error.message);
            return null;
        }
    }

    // B2B veritabanƒ± baƒülantƒ±sƒ±
    async getB2BConnection() {
        try {
            if (!this.b2bPool || !this.b2bPool.connected) {
                console.log("üîó B2B_TRADE_PRO baƒülanƒ±yor...");
                this.b2bPool = await sql.connect(this.b2bConfig);
                console.log("‚úÖ B2B baƒülantƒ±sƒ± ba≈üarƒ±lƒ±");
            }
            return this.b2bPool;
        } catch (error) {
            console.error("‚ùå B2B baƒülantƒ± hatasƒ±:", error.message);
            throw new Error(`B2B DB baƒülantƒ± hatasƒ±: ${error.message}`);
        }
    }

    // Admin yetki kontrol√º
    checkAdminAuth(req) {
        try {
            const userData = this.decodeUserData(req) || 
                           (req.session ? req.session.user : null);
            
            if (!userData) {
                console.log("‚ùå Admin: User data bulunamadƒ±");
                return false;
            }

            const isAdmin = userData.user_type === 'admin' || 
                          userData.user_type === '1' || 
                          userData.user_type === 1 ||
                          userData.kullanici_tipi === 'admin' ||
                          userData.kullanici_tipi === 1;
            
            console.log(`üîê Admin Auth kontrol√º: user_type=${userData.user_type}, isAdmin=${isAdmin}`);
            return isAdmin;
        } catch (error) {
            console.error("‚ùå Admin Auth kontrol hatasƒ±:", error);
            return false;
        }
    }

    // Cache temizleme
    clearB2BCache(cacheKey = null) {
        try {
            if (cacheKey) {
                if (this.cache.has(cacheKey)) {
                    this.cache.delete(cacheKey);
                    console.log(`üßπ Admin Cache temizlendi: ${cacheKey}`);
                }
            } else {
                const previousSize = this.cache.size;
                this.cache.clear();
                console.log(`üßπ Admin T√ºm cache temizlendi: ${previousSize} kayƒ±t silindi`);
            }
        } catch (error) {
            console.error('‚ùå Admin Cache temizleme hatasƒ±:', error);
        }
    }

    // Log kaydƒ±
    async logAction(logType, message, userCode, ipAddress = '') {
        try {
            const pool = await this.getB2BConnection();
            const query = `
                INSERT INTO b2b_system_logs 
                (log_type, module, message, user_code, ip_address, created_at)
                VALUES 
                (@logType, 'b2b_admin', @message, @userCode, @ipAddress, GETDATE())
            `;
            
            await pool.request()
                .input('logType', sql.VarChar(50), logType)
                .input('message', sql.NVarChar(500), message)
                .input('userCode', sql.VarChar(50), userCode)
                .input('ipAddress', sql.VarChar(50), ipAddress)
                .query(query);
                
            console.log(`üìù Admin Log kaydedildi: ${logType} - ${message}`);
        } catch (error) {
            console.error('‚ùå Admin Log kaydetme hatasƒ±:', error.message);
        }
    }

    // Sistem istatistikleri
    async getSystemStats() {
        try {
            const pool = await this.getB2BConnection();
            
            const queries = [
                `SELECT COUNT(*) as campaign_count FROM b2b_campaign_items WHERE is_active = 1`,
                `SELECT COUNT(DISTINCT customer_code) as customer_override_count FROM b2b_customer_overrides WHERE is_active = 1`,
                `SELECT COUNT(*) as settings_count FROM b2b_default_settings`,
                `SELECT COUNT(*) as log_count FROM b2b_system_logs WHERE created_at >= DATEADD(DAY, -7, GETDATE())`,
                `SELECT COUNT(*) as active_customers FROM b2b_customer_overrides WHERE is_active = 1 GROUP BY customer_code`
            ];

            const results = await Promise.all(
                queries.map(query => pool.request().query(query))
            );

            return {
                activeCampaigns: results[0].recordset[0]?.campaign_count || 0,
                customerOverrides: results[1].recordset[0]?.customer_override_count || 0,
                totalSettings: results[2].recordset[0]?.settings_count || 0,
                weeklyLogs: results[3].recordset[0]?.log_count || 0,
                activeCustomers: results[4]?.recordset?.length || 0,
                b2bDatabase: 'B2B_TRADE_PRO',
                updatedAt: new Date().toISOString()
            };

        } catch (error) {
            console.error('‚ùå Admin Sistem istatistikleri hatasƒ±:', error.message);
            return {
                activeCampaigns: 0,
                customerOverrides: 0,
                totalSettings: 0,
                weeklyLogs: 0,
                activeCustomers: 0,
                b2bDatabase: 'B2B_TRADE_PRO',
                error: error.message
            };
        }
    }
