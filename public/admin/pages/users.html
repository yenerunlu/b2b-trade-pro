<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kullanıcı Hesapları</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
            --primary: #2563eb;
            --primary-600: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            --radius: 14px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            padding: 18px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 14px;
        }

        .title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .title h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 0.2px;
        }

        .title p {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { border-color: #cbd5e1; }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-600);
            border-color: var(--primary-600);
        }

        .btn-danger {
            background: #fff;
            border-color: #fecaca;
            color: var(--danger);
        }

        .btn-danger:hover {
            border-color: #fca5a5;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .toolbar {
            padding: 14px;
            display: grid;
            grid-template-columns: 1.4fr 0.7fr 0.7fr auto;
            gap: 10px;
            align-items: center;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .label {
            font-size: 12px;
            color: var(--muted);
        }

        .input, .select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            outline: none;
            background: #fff;
        }

        .input:focus, .select:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
        }

        .table-wrap {
            padding: 0;
            overflow: auto;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 980px;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            text-align: left;
            font-size: 12px;
            color: #334155;
            padding: 12px;
            white-space: nowrap;
        }

        tbody td {
            border-bottom: 1px solid var(--border);
            padding: 12px;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid var(--border);
            background: #fff;
        }

        .badge-success { color: var(--success); border-color: #bbf7d0; background: #f0fdf4; }
        .badge-danger { color: var(--danger); border-color: #fecaca; background: #fef2f2; }
        .badge-warning { color: #92400e; border-color: #fde68a; background: #fffbeb; }
        .badge-muted { color: var(--muted); border-color: #e2e8f0; background: #f8fafc; }

        .row-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            color: #0f172a;
        }

        .icon-btn:hover { border-color: #cbd5e1; }

        .icon-btn.danger { border-color: #fecaca; color: var(--danger); }

        .footer {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--muted);
            font-size: 12px;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
            z-index: 9999;
        }

        .modal-backdrop.active { display: flex; }

        .modal {
            width: 100%;
            max-width: 640px;
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .modal-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .modal-title h2 {
            margin: 0;
            font-size: 16px;
        }

        .modal-title p {
            margin: 0;
            font-size: 12px;
            color: var(--muted);
        }

        .modal-body {
            padding: 14px 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .grid-1 { grid-template-columns: 1fr; }

        .modal-footer {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .help {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
            line-height: 1.45;
        }

        @media (max-width: 900px) {
            .toolbar { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 560px) {
            .toolbar { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <div class="title">
                <h1>Kullanıcı Hesapları</h1>
                <p>Admin / Plasiyer / Müşteri hesaplarını tek yerden yönet.</p>
            </div>
            <div class="actions">
                <button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Yenile</button>
                <button class="btn btn-primary" id="createBtn"><i class="fa-solid fa-user-plus"></i> Yeni Kullanıcı</button>
            </div>
        </div>

        <div class="card">
            <div class="toolbar">
                <div class="field">
                    <div class="label">Arama</div>
                    <input class="input" id="q" placeholder="Kullanıcı kodu, isim veya e-posta..." />
                </div>
                <div class="field">
                    <div class="label">Rol</div>
                    <select class="select" id="role">
                        <option value="">Tümü</option>
                        <option value="admin">Admin</option>
                        <option value="sales">Plasiyer</option>
                        <option value="customer">Müşteri</option>
                    </select>
                </div>
                <div class="field">
                    <div class="label">Durum</div>
                    <select class="select" id="active">
                        <option value="">Tümü</option>
                        <option value="1">Aktif</option>
                        <option value="0">Pasif</option>
                    </select>
                </div>
                <div class="field">
                    <div class="label">&nbsp;</div>
                    <button class="btn btn-primary" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> Ara</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Kullanıcı</th>
                            <th>Rol</th>
                            <th>Ad / Ünvan</th>
                            <th>E-posta</th>
                            <th>Durum</th>
                            <th>İlk Giriş</th>
                            <th>Kilit</th>
                            <th>Hata</th>
                            <th>Son Giriş</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <tr><td colspan="10" style="color:#64748b;">Yükleniyor...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="footer">
                <div id="count">0 kayıt</div>
                <div class="help">Şifreler listede görünmez. Şifre değiştirmek için “Şifre Reset” kullan.</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-backdrop" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <h2 id="userModalTitle">Kullanıcı</h2>
                    <p id="userModalSubtitle">Kullanıcı bilgilerini düzenle.</p>
                </div>
                <button class="icon-btn" id="userModalClose"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid">
                    <div class="field">
                        <div class="label">Kullanıcı Kodu</div>
                        <input class="input" id="formUserCode" placeholder="Örn: ADMIN / PLASIYER001 / S6064" />
                    </div>
                    <div class="field">
                        <div class="label">Rol</div>
                        <select class="select" id="formRole">
                            <option value="admin">Admin</option>
                            <option value="sales">Plasiyer</option>
                            <option value="customer">Müşteri</option>
                        </select>
                    </div>
                    <div class="field">
                        <div class="label">Ad / Ünvan</div>
                        <input class="input" id="formName" placeholder="Örn: Yönetici / Ahmet Yılmaz / Firma" />
                    </div>
                    <div class="field">
                        <div class="label">E-posta</div>
                        <input class="input" id="formEmail" placeholder="ornek@firma.com" />
                    </div>
                    <div class="field">
                        <div class="label">Aktif</div>
                        <select class="select" id="formActive">
                            <option value="1">Aktif</option>
                            <option value="0">Pasif</option>
                        </select>
                    </div>
                    <div class="field">
                        <div class="label">İlk Girişte Şifre Değiştir</div>
                        <select class="select" id="formMustChange">
                            <option value="0">Hayır</option>
                            <option value="1">Evet</option>
                        </select>
                    </div>
                </div>

                <div class="field" id="createPasswordBlock" style="margin-top:12px; display:none;">
                    <div class="label">Başlangıç Şifresi (Opsiyonel)</div>
                    <input class="input" id="formPassword" placeholder="Boş bırakılırsa şifre atanmaz" />
                    <div class="help">Güvenlik için şifreleri sadece reset/oluştur sırasında alıyoruz. Liste API’si şifre döndürmez.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="userModalCancel">İptal</button>
                <button class="btn btn-primary" id="userModalSave"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-backdrop" id="pwModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <h2>Şifre Reset</h2>
                    <p id="pwSubtitle">Kullanıcı için yeni şifre belirle.</p>
                </div>
                <button class="icon-btn" id="pwClose"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid grid-1">
                    <div class="field">
                        <div class="label">Yeni Şifre</div>
                        <input class="input" id="pwNew" placeholder="Örn: YUNLU" />
                    </div>
                    <div class="field">
                        <div class="label">İlk girişte şifre değiştir zorla</div>
                        <select class="select" id="pwForce">
                            <option value="1">Evet</option>
                            <option value="0">Hayır</option>
                        </select>
                    </div>
                </div>
                <div class="help">Bu işlem kullanıcıyı kilitten çıkarır ve hatalı deneme sayısını sıfırlar.</div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="pwCancel">İptal</button>
                <button class="btn btn-primary" id="pwSave"><i class="fa-solid fa-key"></i> Resetle</button>
            </div>
        </div>
    </div>

    <script>
        function encodeUserDataToBase64(userData) {
            try {
                const jsonString = JSON.stringify(userData);
                return btoa(unescape(encodeURIComponent(jsonString)));
            } catch (error) {
                console.error('Base64 encode hatası:', error);
                return '';
            }
        }

        function setAuthHeaders(headers = {}) {
            try {
                const userDataBase64 = localStorage.getItem('b2b_user_data_base64');
                if (userDataBase64) {
                    return {
                        ...headers,
                        'Content-Type': 'application/json',
                        'x-user-data-base64': userDataBase64,
                        'x-user-type': 'admin'
                    };
                }

                const userDataString = localStorage.getItem('b2b_user_data');
                if (userDataString) {
                    const userData = JSON.parse(userDataString);
                    return {
                        ...headers,
                        'Content-Type': 'application/json',
                        'x-user-data-base64': encodeUserDataToBase64(userData),
                        'x-user-type': 'admin'
                    };
                }

                return { ...headers, 'Content-Type': 'application/json' };
            } catch (e) {
                return { ...headers, 'Content-Type': 'application/json' };
            }
        }

        const state = {
            rows: [],
            editingUserCode: null,
            resetUserCode: null
        };

        function roleLabel(role) {
            if (role === 'admin') return 'Admin';
            if (role === 'sales') return 'Plasiyer';
            if (role === 'customer') return 'Müşteri';
            return role || '-';
        }

        function badgeForActive(active) {
            return active === 1
                ? '<span class="badge badge-success"><i class="fa-solid fa-circle-check"></i> Aktif</span>'
                : '<span class="badge badge-danger"><i class="fa-solid fa-circle-xmark"></i> Pasif</span>';
        }

        function badgeForMustChange(flag) {
            return flag === 1
                ? '<span class="badge badge-warning"><i class="fa-solid fa-triangle-exclamation"></i> Zorunlu</span>'
                : '<span class="badge badge-muted"><i class="fa-solid fa-circle"></i> Normal</span>';
        }

        function badgeForLock(lockedUntil) {
            if (lockedUntil && Date.parse(lockedUntil) > Date.now()) {
                return '<span class="badge badge-danger"><i class="fa-solid fa-lock"></i> Kilitli</span>';
            }
            return '<span class="badge badge-muted"><i class="fa-solid fa-lock-open"></i> Açık</span>';
        }

        function formatDate(dt) {
            if (!dt) return '-';
            try {
                const d = new Date(dt);
                if (Number.isNaN(d.getTime())) return String(dt);
                return d.toLocaleString('tr-TR');
            } catch (e) {
                return String(dt);
            }
        }

        function render() {
            const tbody = document.getElementById('tbody');
            const count = document.getElementById('count');

            count.textContent = `${state.rows.length} kayıt`;

            if (!state.rows.length) {
                tbody.innerHTML = '<tr><td colspan="10" style="color:#64748b;">Kayıt bulunamadı.</td></tr>';
                return;
            }

            tbody.innerHTML = state.rows.map(r => {
                const isLocked = r.locked_until && Date.parse(r.locked_until) > Date.now();
                const unlockBtn = isLocked
                    ? `<button class="icon-btn" title="Kilidi Aç" onclick="unlockUser('${r.user_code}')"><i class="fa-solid fa-unlock"></i></button>`
                    : `<button class="icon-btn" title="Kilidi Aç" disabled style="opacity:.45; cursor:not-allowed;"><i class="fa-solid fa-unlock"></i></button>`;

                return `
                    <tr>
                        <td><strong>${r.user_code}</strong></td>
                        <td>${roleLabel(r.role)}</td>
                        <td>${r.customer_name || '-'}</td>
                        <td>${r.email || '-'}</td>
                        <td>${badgeForActive(r.active)}</td>
                        <td>${badgeForMustChange(r.must_change_password)}</td>
                        <td>${badgeForLock(r.locked_until)}</td>
                        <td>${Number(r.failed_attempts || 0)}</td>
                        <td>${formatDate(r.last_login_at)}</td>
                        <td>
                            <div class="row-actions">
                                <button class="icon-btn" title="Düzenle" onclick="openEdit('${r.user_code}')"><i class="fa-solid fa-pen"></i></button>
                                <button class="icon-btn" title="Şifre Reset" onclick="openReset('${r.user_code}')"><i class="fa-solid fa-key"></i></button>
                                ${unlockBtn}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadUsers() {
            const q = document.getElementById('q').value || '';
            const role = document.getElementById('role').value || '';
            const active = document.getElementById('active').value || '';

            const params = new URLSearchParams();
            if (q.trim()) params.set('q', q.trim());
            if (role) params.set('role', role);
            if (active) params.set('active', active);

            const url = `/api/admin/auth-users?${params.toString()}`;

            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '<tr><td colspan="10" style="color:#64748b;">Yükleniyor...</td></tr>';

            const res = await fetch(url, { headers: setAuthHeaders() });
            const data = await res.json();

            if (!res.ok || !data.success) {
                throw new Error(data.error || 'Liste alınamadı');
            }

            state.rows = Array.isArray(data.data) ? data.data : [];
            render();
        }

        function openCreate() {
            state.editingUserCode = null;
            document.getElementById('userModalTitle').textContent = 'Yeni Kullanıcı';
            document.getElementById('userModalSubtitle').textContent = 'Yeni hesap oluştur.';

            document.getElementById('formUserCode').value = '';
            document.getElementById('formUserCode').disabled = false;
            document.getElementById('formRole').value = 'customer';
            document.getElementById('formName').value = '';
            document.getElementById('formEmail').value = '';
            document.getElementById('formActive').value = '1';
            document.getElementById('formMustChange').value = '1';
            document.getElementById('formPassword').value = '';

            document.getElementById('createPasswordBlock').style.display = 'block';
            openModal('userModal');
        }

        function openEdit(userCode) {
            const row = state.rows.find(r => r.user_code === userCode);
            if (!row) return;

            state.editingUserCode = userCode;
            document.getElementById('userModalTitle').textContent = 'Kullanıcı Düzenle';
            document.getElementById('userModalSubtitle').textContent = 'Rol, durum, ilk giriş bayrağı vb.';

            document.getElementById('formUserCode').value = row.user_code;
            document.getElementById('formUserCode').disabled = true;
            document.getElementById('formRole').value = row.role || 'customer';
            document.getElementById('formName').value = row.customer_name || '';
            document.getElementById('formEmail').value = row.email || '';
            document.getElementById('formActive').value = String(row.active ?? 1);
            document.getElementById('formMustChange').value = String(row.must_change_password ?? 0);
            document.getElementById('formPassword').value = '';

            document.getElementById('createPasswordBlock').style.display = 'none';
            openModal('userModal');
        }

        function openReset(userCode) {
            state.resetUserCode = userCode;
            document.getElementById('pwSubtitle').textContent = `${userCode} için yeni şifre belirle.`;
            document.getElementById('pwNew').value = '';
            document.getElementById('pwForce').value = '1';
            openModal('pwModal');
        }

        async function unlockUser(userCode) {
            if (!confirm(`${userCode} kilidi açılsın mı?`)) return;
            const res = await fetch(`/api/admin/auth-users/${encodeURIComponent(userCode)}/unlock`, {
                method: 'POST',
                headers: setAuthHeaders()
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                alert(data.error || 'Kilit açılamadı');
                return;
            }
            await loadUsers();
        }

        async function saveUser() {
            const user_code = document.getElementById('formUserCode').value.trim().toUpperCase();
            const role = document.getElementById('formRole').value;
            const customer_name = document.getElementById('formName').value.trim();
            const email = document.getElementById('formEmail').value.trim();
            const active = document.getElementById('formActive').value === '1';
            const must_change_password = document.getElementById('formMustChange').value === '1';

            if (!user_code) {
                alert('Kullanıcı kodu zorunludur');
                return;
            }

            if (!role) {
                alert('Rol zorunludur');
                return;
            }

            if (!state.editingUserCode) {
                const password = document.getElementById('formPassword').value;
                const res = await fetch('/api/admin/auth-users', {
                    method: 'POST',
                    headers: setAuthHeaders(),
                    body: JSON.stringify({ user_code, role, customer_name, email, active, must_change_password, password })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    alert(data.error || 'Kullanıcı oluşturulamadı');
                    return;
                }
            } else {
                const res = await fetch(`/api/admin/auth-users/${encodeURIComponent(state.editingUserCode)}`, {
                    method: 'PUT',
                    headers: setAuthHeaders(),
                    body: JSON.stringify({ role, customer_name, email, active, must_change_password })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    alert(data.error || 'Kullanıcı güncellenemedi');
                    return;
                }
            }

            closeModal('userModal');
            await loadUsers();
        }

        async function saveReset() {
            const userCode = state.resetUserCode;
            if (!userCode) return;

            const new_password = document.getElementById('pwNew').value.trim();
            const must_change_password = document.getElementById('pwForce').value === '1';

            if (!new_password) {
                alert('Yeni şifre zorunludur');
                return;
            }

            const res = await fetch(`/api/admin/auth-users/${encodeURIComponent(userCode)}/reset-password`, {
                method: 'POST',
                headers: setAuthHeaders(),
                body: JSON.stringify({ new_password, must_change_password })
            });

            const data = await res.json();
            if (!res.ok || !data.success) {
                alert(data.error || 'Şifre resetlenemedi');
                return;
            }

            closeModal('pwModal');
            state.resetUserCode = null;
            await loadUsers();
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function wire() {
            document.getElementById('refreshBtn').addEventListener('click', () => loadUsers().catch(e => alert(e.message)));
            document.getElementById('createBtn').addEventListener('click', openCreate);
            document.getElementById('searchBtn').addEventListener('click', () => loadUsers().catch(e => alert(e.message)));

            document.getElementById('q').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    loadUsers().catch(err => alert(err.message));
                }
            });

            document.getElementById('userModalClose').addEventListener('click', () => closeModal('userModal'));
            document.getElementById('userModalCancel').addEventListener('click', () => closeModal('userModal'));
            document.getElementById('userModalSave').addEventListener('click', () => saveUser().catch(e => alert(e.message)));

            document.getElementById('pwClose').addEventListener('click', () => closeModal('pwModal'));
            document.getElementById('pwCancel').addEventListener('click', () => closeModal('pwModal'));
            document.getElementById('pwSave').addEventListener('click', () => saveReset().catch(e => alert(e.message)));

            document.getElementById('userModal').addEventListener('click', (e) => {
                if (e.target && e.target.id === 'userModal') closeModal('userModal');
            });

            document.getElementById('pwModal').addEventListener('click', (e) => {
                if (e.target && e.target.id === 'pwModal') closeModal('pwModal');
            });
        }

        window.openEdit = openEdit;
        window.openReset = openReset;
        window.unlockUser = unlockUser;

        document.addEventListener('DOMContentLoaded', () => {
            wire();
            loadUsers().catch(err => {
                console.error(err);
                alert('Kullanıcı listesi alınamadı: ' + err.message);
            });
        });
    </script>
</body>
</html>
