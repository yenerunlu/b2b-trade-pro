<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sipariş Yönetimi • B2B Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root{--p:#2563eb;--pd:#1d4ed8;--bg:#f8fafc;--t:#0f172a;--g:#64748b;--b:#e2e8f0;--bb:#f1f5f9;--r:14px;--sh:0 2px 10px rgba(15,23,42,.08)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--t);height:100vh;overflow:hidden;padding:16px}
    .page{height:100%;display:flex;flex-direction:column;gap:12px}
    .topbar{background:#fff;border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--sh);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{display:flex;align-items:center;gap:10px;font-weight:900}
    .subtitle{color:var(--g);font-size:.85rem;margin-top:2px;font-weight:600}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{border:1px solid var(--b);background:#fff;color:var(--t);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:var(--bb)}
    .btn-primary{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.08);color:var(--pd)}
    .shell{flex:1;min-height:0;display:flex;gap:12px}
    .sidebar{flex:0 0 220px;min-width:220px;display:flex;flex-direction:column;gap:10px;min-height:0}
    .side{background:#fff;border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--sh);padding:10px;display:flex;flex-direction:column;gap:8px}
    .side-item{border:1px solid var(--b);background:#fff;border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:900;font-size:.9rem}
    .side-item i{width:18px;text-align:center;color:var(--g)}
    .side-item:hover{background:var(--bb)}
    .side-item.active{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.08)}
    .side-item.active i{color:var(--pd)}
    .content{flex:1;min-width:0;min-height:0;display:flex;flex-direction:column;gap:12px}
    .panel{background:#fff;border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .ph{padding:12px 14px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ph h3{font-size:.95rem;font-weight:900;display:flex;align-items:center;gap:8px}
    .pb{padding:14px;min-height:0;overflow:auto}
    .muted{color:var(--g);font-size:.85rem}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{border:1px solid var(--b);border-radius:var(--r);overflow:hidden}
    .ch{padding:10px 12px;background:var(--bb);border-bottom:1px solid var(--b);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cb{padding:12px}
    .span-6{grid-column:span 6}
    .span-12{grid-column:span 12}
    label{display:block;font-weight:900;font-size:.82rem;color:#334155;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;font-size:.9rem}
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
    .f6{grid-column:span 6}
    .f4{grid-column:span 4}
    .f8{grid-column:span 8}
    .f12{grid-column:span 12}
    .table{width:100%;border-collapse:collapse}
    .table th{background:#f8fafc;border-bottom:1px solid var(--b);text-align:left;font-size:.78rem;text-transform:uppercase;letter-spacing:.06em;color:#475569;padding:10px 12px}
    .table td{border-bottom:1px solid var(--bb);padding:10px 12px;font-size:.9rem;color:#334155;vertical-align:top}
    .right{text-align:right}
    .icon-btn{width:34px;height:34px;border-radius:10px;border:1px solid var(--b);background:#fff;cursor:pointer}
    .icon-btn:hover{background:var(--bb)}
    .hidden{display:none!important}
    @media(max-width:980px){body{padding:12px}.shell{flex-direction:column}.sidebar{flex:0 0 auto;min-width:0}.span-6{grid-column:span 12}.f4,.f6,.f8{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <div>
        <div class="title"><i class="fas fa-shopping-cart" style="color:var(--pd)"></i> Sipariş Yönetimi</div>
        <div class="subtitle">Dağıtım ayarları (bölge → ambar öncelikleri) + Karşılanamayan fişi</div>
      </div>
      <div class="actions">
        <button class="btn" id="btnReload"><i class="fas fa-rotate"></i> Yenile</button>
        <button class="btn btn-primary" id="btnSave"><i class="fas fa-save"></i> Kaydet</button>
      </div>
    </div>

    <div class="shell">
      <div class="sidebar">
        <div class="side">
          <div class="side-item active" data-view="orders"><i class="fas fa-list"></i> Siparişler</div>
          <div class="side-item" data-view="distribution"><i class="fas fa-sitemap"></i> Dağıtım Ayarları</div>
        </div>
        <div class="panel">
          <div class="ph"><h3><i class="fas fa-circle-info"></i> Not</h3></div>
          <div class="pb"><div class="muted" style="line-height:1.6;">Bu adımda sadece ayar ekranı hazır. Sonraki adımda siparişi ambar bazlı fişlere bölen mantığı backend’e bağlayacağız.</div></div>
        </div>
      </div>

      <div class="content">
        <div class="panel" id="view-orders">
          <div class="ph"><h3><i class="fas fa-list"></i> Siparişler</h3><div class="muted">(Yakında)</div></div>
          <div class="pb"><div class="muted" style="line-height:1.6;">Sipariş listeleme/filtreleme/detay ekranını bir sonraki iterasyonda ekleyeceğiz.</div></div>
        </div>

        <div class="panel hidden" id="view-distribution">
          <div class="ph"><h3><i class="fas fa-sitemap"></i> Dağıtım Ayarları</h3><div class="muted">Manuel yönetim</div></div>
          <div class="pb">
            <div class="grid">
              <div class="card span-6">
                <div class="ch"><span>Ambarlar</span><span class="muted">INVENNO + Ad</span></div>
                <div class="cb">
                  <div class="row" style="margin-bottom:10px;">
                    <div class="f4"><label>INVENNO</label><input id="newWhInv" type="number" placeholder="0" /></div>
                    <div class="f8"><label>Ambar Adı</label><input id="newWhName" type="text" placeholder="IKITELLI" /></div>
                    <div class="f12" style="display:flex;justify-content:flex-end;gap:10px;">
                      <button class="btn" id="btnAddWh"><i class="fas fa-plus"></i> Ekle</button>
                    </div>
                  </div>
                  <table class="table" id="tblWh"><thead><tr><th style="width:120px;">INVENNO</th><th>Ad</th><th class="right" style="width:120px;">İşlem</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <div class="card span-6">
                <div class="ch"><span>Bölgeler</span><span class="muted">Kod listesi</span></div>
                <div class="cb">
                  <div class="row" style="margin-bottom:10px;">
                    <div class="f6"><label>Bölge Kodu</label><input id="newRegion" type="text" placeholder="35" /></div>
                    <div class="f6" style="display:flex;justify-content:flex-end;gap:10px;">
                      <button class="btn" id="btnAddRegion"><i class="fas fa-plus"></i> Ekle</button>
                    </div>
                  </div>
                  <table class="table" id="tblRegion"><thead><tr><th>Bölge Kodu</th><th class="right" style="width:120px;">İşlem</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <div class="card span-12">
                <div class="ch"><span>Öncelik Sırası (Bölge Bazlı)</span><span class="muted">Seçerek sırala</span></div>
                <div class="cb">
                  <div class="row" style="margin-bottom:10px;">
                    <div class="f4"><label>Bölge Seç</label><select id="selRegion"></select></div>
                    <div class="f8"><label>Öncelik (1 → N)</label><div class="muted">Her sıraya bir ambar seç: aynı ambarı birden fazla sıraya seçme.</div></div>
                  </div>
                  <div class="row" id="priorityRow"></div>
                  <div class="f12" style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-top:10px;">
                    <button class="btn" id="btnFillDefault"><i class="fas fa-arrow-rotate-left"></i> Varsayılan</button>
                    <button class="btn btn-primary" id="btnSaveRegion"><i class="fas fa-check"></i> Bölgeyi Kaydet</button>
                  </div>
                  <div class="muted" id="regionSaveStatus" style="margin-top:10px; line-height:1.6;"></div>
                  <div style="margin-top:10px;">
                    <table class="table" id="tblPrioritySummary">
                      <thead>
                        <tr>
                          <th style="width:140px;">Bölge</th>
                          <th>Öncelik Sırası</th>
                          <th class="right" style="width:160px;">İşlem</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="card span-12">
                <div class="ch"><span>Karşılanamayan Fişi</span><span class="muted">Tek fiş / gerçek miktar</span></div>
                <div class="cb">
                  <div class="row">
                    <div class="f4"><label>Karşılanamayan Ambar</label><select id="selUnfulfilledWh"></select></div>
                    <div class="f8">
                      <label>Belge No (DOCODE) Metni</label>
                      <div style="display:flex; gap:10px; align-items:center;">
                        <input id="unfulfilledDocodeText" type="text" placeholder="KARŞILANAMADI" />
                        <button class="btn" id="btnSaveUnfulfilledDocode" style="padding:10px 12px;"><i class="fas fa-save"></i> Kaydet</button>
                      </div>
                    </div>
                    <div class="f12"><label>Davranış</label><div class="muted" style="line-height:1.6;">Karşılanamayan ürünler tek bir fiş içinde, gerçek adet/fiyat/iskonto ile sipariş gibi düşer.</div></div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    function encodeUserDataToBase64(userData){try{return btoa(unescape(encodeURIComponent(JSON.stringify(userData))))}catch(e){return ''}}
    function setAuthHeaders(headers={}){try{const s=localStorage.getItem('b2b_user_data');if(s){const u=JSON.parse(s);return {...headers,'Content-Type':'application/json','x-user-data-base64':encodeUserDataToBase64(u),'x-user-type':'admin'};}return {...headers,'Content-Type':'application/json'};}catch(e){return {...headers,'Content-Type':'application/json'};}}

    const state={settings:null,selectedRegion:null};

    function uniqWarehouses(list){const map=new Map();(list||[]).forEach(w=>{const inv=Number(w.invNo);const name=String(w.name||'').trim();if(Number.isFinite(inv)&&name) map.set(inv,{invNo:inv,name});});return Array.from(map.values()).sort((a,b)=>a.invNo-b.invNo)}
    function uniqRegions(list){const set=new Set();(list||[]).forEach(r=>{const v=String(r||'').trim();if(v) set.add(v);});return Array.from(set.values()).sort((a,b)=>String(a).localeCompare(String(b),'tr'))}

    function showView(id){
      document.querySelectorAll('.side-item').forEach(x=>x.classList.toggle('active',x.dataset.view===id));
      document.getElementById('view-orders').classList.toggle('hidden',id!=='orders');
      document.getElementById('view-distribution').classList.toggle('hidden',id!=='distribution');
    }

    function getWarehouseLabel(invNo){
      const n=Number(invNo);
      const wh=(state.settings.warehouses||[]).find(w=>Number(w.invNo)===n);
      if(!wh) return String(invNo);
      return `${wh.invNo} • ${wh.name}`;
    }

    function renderPrioritySummary(){
      const tbody=document.querySelector('#tblPrioritySummary tbody');
      const status=document.getElementById('regionSaveStatus');
      if(!tbody) return;
      tbody.innerHTML='';

      const ps=state.settings.prioritySettings||{};
      const regions=(state.settings.regions||[]);

      const anySaved = Object.keys(ps).length > 0;
      status.textContent = anySaved
        ? 'Kaydedilen öncelikler aşağıda listelenir. İstersen bölgeyi seçip yeniden kaydedebilir veya silebilirsin.'
        : 'Henüz hiçbir bölge için öncelik kaydı yok. Bir bölge seçip “Bölgeyi Kaydet” deyin.';

      for(const region of regions){
        const arr = Array.isArray(ps[region]) ? ps[region] : null;
        if(!arr || arr.length === 0) continue;

        const tr=document.createElement('tr');
        const pretty = arr.map(getWarehouseLabel).join('  →  ');
        tr.innerHTML=`<td>${region}</td><td>${pretty}</td><td class="right"></td>`;

        const tdAct = tr.querySelector('td.right');

        const btnEdit=document.createElement('button');
        btnEdit.className='icon-btn';
        btnEdit.title='Düzenle';
        btnEdit.innerHTML='<i class="fas fa-pen"></i>';
        btnEdit.addEventListener('click',()=>{
          state.selectedRegion=region;
          document.getElementById('selRegion').value=region;
          renderPriorityEditor();
        });

        const btnDel=document.createElement('button');
        btnDel.className='icon-btn';
        btnDel.title='Sil';
        btnDel.innerHTML='<i class="fas fa-trash"></i>';
        btnDel.addEventListener('click',async()=>{
          try{
            delete state.settings.prioritySettings[region];
            await saveSettings();
            renderPrioritySummary();
            alert(`Silindi: ${region}`);
          }catch(err){
            console.error(err);
            alert(err.message||String(err));
          }
        });

        tdAct.appendChild(btnEdit);
        tdAct.appendChild(btnDel);

        tbody.appendChild(tr);
      }
    }

    async function fetchSettings(){
      const res=await fetch('/api/b2b/admin/order-settings',{method:'GET',headers:setAuthHeaders()});
      if(!res.ok) throw new Error('Ayarlar alınamadı: '+res.status);
      const json=await res.json();
      if(!json.success) throw new Error(json.error||'Ayarlar alınamadı');
      return json.data;
    }

    async function saveSettings(){
      const res=await fetch('/api/b2b/admin/order-settings',{method:'PUT',headers:setAuthHeaders(),body:JSON.stringify({settings:state.settings})});
      if(!res.ok) throw new Error('Kaydetme hatası: '+res.status);
      const json=await res.json();
      if(!json.success) throw new Error(json.error||'Kaydedilemedi');
      return json;
    }

    function renderWh(){
      const tbody=document.querySelector('#tblWh tbody');
      tbody.innerHTML='';
      (state.settings.warehouses||[]).forEach(w=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${w.invNo}</td><td>${w.name}</td><td class="right"><button class="icon-btn" title="Sil"><i class="fas fa-trash"></i></button></td>`;
        tr.querySelector('button').addEventListener('click',()=>{
          state.settings.warehouses=(state.settings.warehouses||[]).filter(x=>Number(x.invNo)!==Number(w.invNo));
          state.settings.warehouses=uniqWarehouses(state.settings.warehouses);
          renderAll();
        });
        tbody.appendChild(tr);
      });
    }

    function renderRegions(){
      const tbody=document.querySelector('#tblRegion tbody');
      tbody.innerHTML='';
      (state.settings.regions||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r}</td><td class="right"><button class="icon-btn" title="Sil"><i class="fas fa-trash"></i></button></td>`;
        tr.querySelector('button').addEventListener('click',()=>{
          const code=String(r||'').trim();
          state.settings.regions=(state.settings.regions||[]).filter(x=>String(x||'').trim()!==code);
          if(state.settings.prioritySettings) delete state.settings.prioritySettings[code];
          state.settings.regions=uniqRegions(state.settings.regions);
          if(state.selectedRegion===code) state.selectedRegion=(state.settings.regions||[])[0]||null;
          renderAll();
        });
        tbody.appendChild(tr);
      });
    }

    function renderSelects(){
      const wh=state.settings.warehouses||[];
      const regions=state.settings.regions||[];

      const selRegion=document.getElementById('selRegion');
      selRegion.innerHTML=regions.map(r=>`<option value="${r}">${r}</option>`).join('');
      if(!state.selectedRegion) state.selectedRegion=regions[0]||null;
      if(state.selectedRegion && !regions.includes(state.selectedRegion)) state.selectedRegion=regions[0]||null;
      if(state.selectedRegion) selRegion.value=state.selectedRegion;

      const selUn=document.getElementById('selUnfulfilledWh');
      selUn.innerHTML=wh.map(w=>`<option value="${w.invNo}">${w.invNo} • ${w.name}</option>`).join('');
      selUn.value=String(state.settings.unfulfilledWarehouse ?? (wh[0]?.invNo ?? 0));

      document.getElementById('unfulfilledDocodeText').value=String(state.settings.unfulfilledDocodeText||'');
    }

    function renderPriorityEditor(){
      const wrap=document.getElementById('priorityRow');
      wrap.innerHTML='';

      const wh=state.settings.warehouses||[];
      const region=state.selectedRegion;
      if(!region){
        wrap.innerHTML='<div class="f12 muted">Önce bölge ekleyin.</div>';
        return;
      }

      const current=(state.settings.prioritySettings && state.settings.prioritySettings[region]) ? state.settings.prioritySettings[region].slice() : wh.map(x=>x.invNo);
      const count=Math.max(wh.length, current.length);

      for(let i=0;i<count;i++){
        const div=document.createElement('div');
        div.className='f4';
        const label=document.createElement('label');
        label.textContent=`Öncelik ${i+1}`;
        const sel=document.createElement('select');
        sel.dataset.idx=String(i);
        sel.innerHTML=wh.map(w=>`<option value="${w.invNo}">${w.invNo} • ${w.name}</option>`).join('');
        sel.value=String(current[i] ?? wh[i]?.invNo ?? wh[0]?.invNo ?? 0);
        div.appendChild(label);
        div.appendChild(sel);
        wrap.appendChild(div);
      }
    }

    function readPriorityFromUI(){
      const selects=Array.from(document.querySelectorAll('#priorityRow select'));
      const arr=selects.map(s=>Number(s.value)).filter(n=>Number.isFinite(n));
      const unique=[];
      for(const n of arr){ if(!unique.includes(n)) unique.push(n); }
      return unique;
    }

    function renderAll(){
      state.settings.warehouses=uniqWarehouses(state.settings.warehouses||[]);
      state.settings.regions=uniqRegions(state.settings.regions||[]);
      state.settings.prioritySettings=state.settings.prioritySettings||{};
      renderWh();
      renderRegions();
      renderSelects();
      renderPriorityEditor();
      renderPrioritySummary();
    }

    function wire(){
      document.querySelectorAll('.side-item').forEach(el=>el.addEventListener('click',()=>showView(el.dataset.view)));

      document.getElementById('btnAddWh').addEventListener('click',()=>{
        const inv=Number(document.getElementById('newWhInv').value);
        const name=String(document.getElementById('newWhName').value||'').trim();
        if(!Number.isFinite(inv) || !name) return;
        state.settings.warehouses=uniqWarehouses([...(state.settings.warehouses||[]),{invNo:inv,name}]);
        document.getElementById('newWhInv').value='';
        document.getElementById('newWhName').value='';
        renderAll();
      });

      document.getElementById('btnAddRegion').addEventListener('click',()=>{
        const code=String(document.getElementById('newRegion').value||'').trim();
        if(!code) return;
        state.settings.regions=uniqRegions([...(state.settings.regions||[]),code]);
        document.getElementById('newRegion').value='';
        if(!state.selectedRegion) state.selectedRegion=code;
        renderAll();
      });

      document.getElementById('selRegion').addEventListener('change',(e)=>{
        state.selectedRegion=e.target.value;
        renderPriorityEditor();
      });

      document.getElementById('btnFillDefault').addEventListener('click',()=>{
        const wh=state.settings.warehouses||[];
        const r=state.selectedRegion;
        if(!r) return;
        state.settings.prioritySettings[r]=wh.map(x=>x.invNo);
        renderPriorityEditor();
      });

      document.getElementById('btnSaveRegion').addEventListener('click',()=>{
        const r=state.selectedRegion;
        if(!r) return;
        state.settings.prioritySettings[r]=readPriorityFromUI();
        renderPrioritySummary();
        alert(`Bölge kaydedildi: ${r}`);
      });

      document.getElementById('selUnfulfilledWh').addEventListener('change',(e)=>{
        state.settings.unfulfilledWarehouse=Number(e.target.value);
      });
      document.getElementById('unfulfilledDocodeText').addEventListener('input',(e)=>{
        state.settings.unfulfilledDocodeText=String(e.target.value||'');
      });

      document.getElementById('btnSaveUnfulfilledDocode').addEventListener('click',async()=>{
        try{
          state.settings.unfulfilledWarehouse=Number(document.getElementById('selUnfulfilledWh').value);
          state.settings.unfulfilledDocodeText=String(document.getElementById('unfulfilledDocodeText').value||'');
          await saveSettings();
          alert('Belge No (DOCODE) metni kaydedildi');
        }catch(err){
          console.error(err);
          alert(err.message||String(err));
        }
      });

      document.getElementById('btnReload').addEventListener('click',async()=>{
        try{
          state.settings=await fetchSettings();
          state.selectedRegion=(state.settings.regions||[])[0]||null;
          renderAll();
        }catch(err){
          console.error(err);
          alert(err.message||String(err));
        }
      });

      document.getElementById('btnSave').addEventListener('click',async()=>{
        try{
          state.settings.unfulfilledWarehouse=Number(document.getElementById('selUnfulfilledWh').value);
          state.settings.unfulfilledDocodeText=String(document.getElementById('unfulfilledDocodeText').value||'');
          if(state.selectedRegion){
            state.settings.prioritySettings[state.selectedRegion]=readPriorityFromUI();
          }
          await saveSettings();
          alert('Kaydedildi');
        }catch(err){
          console.error(err);
          alert(err.message||String(err));
        }
      });
    }

    async function init(){
      wire();
      try{
        state.settings=await fetchSettings();
      }catch(e){
        state.settings={warehouses:[{invNo:0,name:'MERKEZ'},{invNo:1,name:'IKITELLI'},{invNo:2,name:'BOSTANCI'},{invNo:3,name:'DEPO'}],regions:['34','35','36','37','38','102'],prioritySettings:{},unfulfilledWarehouse:3,unfulfilledDocodeText:'KARŞILANAMADI'};
      }
      state.selectedRegion=(state.settings.regions||[])[0]||null;
      renderAll();
    }

    document.addEventListener('DOMContentLoaded',init);
  </script>
</body>
</html>
