<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Trade Pro | Müşteri Paneli</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #dbeafe;
            --secondary: #f59e0b;
            --success: #10b981;
            --success-dark: #059669;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --gray-lighter: #f1f5f9;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --transition-fast: all 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .logo {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1rem;
            text-align: center;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .logo span {
            color: var(--secondary);
        }

        .customer-info {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1rem;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-code {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: var(--border-radius);
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            gap: 2rem;
        }

        .welcome-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .welcome-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .welcome-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .welcome-text p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .exchange-rates-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .exchange-rates-simple {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .exchange-rates-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
        }

        .currency-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .currency-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .eur-badge .currency-symbol {
            color: #003399;
            font-weight: 700;
        }

        .usd-badge .currency-symbol {
            color: #3c3b6e;
            font-weight: 700;
        }

        .currency-code {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .currency-badge .rate-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary-dark);
            letter-spacing: 0.5px;
        }

        .exchange-divider {
            width: 1px;
            height: 20px;
            background: var(--gray-light);
        }

        .exchange-source-mini {
            font-size: 0.75rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.375rem;
            opacity: 0.8;
        }

        .exchange-source-mini i {
            font-size: 0.7rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex: 1;
            justify-content: flex-end;
        }

        .cart-indicator {
            position: relative;
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            box-shadow: var(--shadow);
            background: linear-gradient(135deg, var(--success), var(--success-dark));
        }

        .cart-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            color: var(--dark);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            border: 2px solid var(--success);
        }

        .page-content {
            flex: 1;
            padding: 2rem;
            overflow: auto;
        }

        .search-slider-container {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .search-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--border-radius);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3), 0 4px 20px rgba(0,0,0,0.08);
            padding: 1.5rem;
            border: 1px solid rgba(37, 99, 235, 0.2);
            position: relative;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .search-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        .search-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid var(--warning);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
        }

        .search-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        .advanced-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .filter-toggle-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-toggle-btn {
            background: #ffffff;
            color: var(--dark);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }

        .filter-toggle-btn:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .filter-chip-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(37, 99, 235, 0.25);
            background: rgba(37, 99, 235, 0.08);
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .filter-chip button {
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--primary-dark);
            font-size: 0.95rem;
            line-height: 1;
        }

        .filter-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .filter-modal {
            width: min(980px, calc(100vw - 24px));
            max-height: min(720px, calc(100vh - 24px));
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
        }

        .filter-modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .filter-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            color: var(--dark);
        }

        .filter-modal-close {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
            padding: 6px 8px;
            color: #334155;
        }

        .filter-modal-body {
            padding: 14px 16px;
            overflow: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .filter-panel {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 340px;
        }

        .filter-panel-head {
            padding: 10px 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .filter-panel-head strong {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .filter-search {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
        }

        .filter-list {
            padding: 10px 12px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
        }

        .filter-item:hover {
            border-color: rgba(37, 99, 235, 0.4);
            background: rgba(37, 99, 235, 0.05);
        }

        .filter-item input {
            width: 18px;
            height: 18px;
        }

        .filter-item .label {
            font-weight: 700;
            color: #0f172a;
            font-size: 0.95rem;
        }

        .filter-modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-footer-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-secondary {
            background: #ffffff;
            color: #0f172a;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 800;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 900;
        }

        @media (max-width: 900px) {
            .filter-modal-body {
                grid-template-columns: 1fr;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius-sm);
            background: white;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .slider-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .slider {
            display: flex;
            transition: transform 0.5s ease;
            height: 100%;
        }

        .slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            padding: 2rem;
        }

        .slider-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
        }

        .slider-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: var(--transition);
        }

        .slider-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .products-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--light), var(--gray-lighter));
            border-bottom: 1px solid var(--gray-light);
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        .table-meta {
            margin-left: auto;
            font-size: 0.82rem;
            color: var(--gray);
            font-weight: 600;
            opacity: 0.85;
            white-space: nowrap;
        }

        .products-table-container {
            overflow-x: auto;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .products-table thead {
            background: linear-gradient(135deg, var(--primary-light), #e0f2fe);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .products-table th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 700;
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 2px solid var(--gray-light);
        }

        .products-table th:last-child {
            border-right: none;
        }

        .products-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid rgba(100, 116, 139, 0.22);
            vertical-align: middle;
            border-right: 1px solid rgba(100, 116, 139, 0.12);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: none;
        }

        .products-table td:last-child {
            border-right: none;
        }

        .products-table tbody tr {
            transition: var(--transition-fast);
        }

        .products-table tbody tr:hover {
            background: var(--gray-lighter);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @keyframes campaignGlow {
            0%, 100% {
                background: rgba(245, 158, 11, 0.06);
                box-shadow: 0 0 0 rgba(245, 158, 11, 0);
                transform: translateY(0);
            }
            50% {
                background: rgba(245, 158, 11, 0.14);
                box-shadow: 0 10px 24px rgba(245, 158, 11, 0.18);
                transform: translateY(-1px);
            }
        }

        .products-table tbody tr.campaign-row {
            animation: campaignGlow 2.4s ease-in-out infinite;
        }

        .products-table tbody tr.in-stock-found {
            background: rgba(34, 197, 94, 0.08);
            border-left: 4px solid rgba(34, 197, 94, 0.7);
        }

        .products-table tbody tr.in-stock-found:hover {
            background: rgba(34, 197, 94, 0.12);
            box-shadow: 0 10px 24px rgba(34, 197, 94, 0.12);
        }

        .product-image {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-sm);
            background: linear-gradient(135deg, var(--gray-lighter), var(--gray-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 1.1rem;
        }

        .product-code {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.85rem;
        }

        .product-name {
            font-weight: 600;
            color: var(--dark);
            line-height: 1.3;
            font-size: 0.9rem;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            max-width: none;
        }

        .product-oem {
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .manufacturer-badge {
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .campaign-badge {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            white-space: nowrap;
        }

        .discount-badge {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            white-space: nowrap;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .stock-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 800;
            line-height: 1.2;
            border: 1px solid rgba(148, 163, 184, 0.55);
            color: rgba(100, 116, 139, 0.9);
            min-width: 74px;
            text-align: center;
            background: transparent;
        }

        .stock-pill.meter {
            position: relative;
            overflow: hidden;
            isolation: isolate;
            padding: 2px 10px;
            border-color: rgba(148, 163, 184, 0.6);
            background: rgba(148, 163, 184, 0.06);
        }

        .stock-pill.meter .fill {
            position: absolute;
            inset: 0;
            width: var(--fill, 0%);
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.20), rgba(34, 197, 94, 0.10));
            border-right: 1px solid rgba(34, 197, 94, 0.25);
            z-index: 0;
            transition: width 220ms ease, background 220ms ease;
        }

        .stock-pill.meter .txt {
            position: relative;
            z-index: 1;
            letter-spacing: 0.2px;
        }

        .stock-pill.meter.lvl-high {
            border-color: rgba(34, 197, 94, 0.55);
            color: rgba(6, 95, 70, 0.95);
        }

        .stock-pill.meter.lvl-high .fill {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.26), rgba(34, 197, 94, 0.12));
            border-right-color: rgba(34, 197, 94, 0.28);
        }

        .stock-pill.meter.lvl-medium {
            border-color: rgba(245, 158, 11, 0.55);
            color: rgba(146, 64, 14, 0.95);
        }

        .stock-pill.meter.lvl-medium .fill {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.26), rgba(245, 158, 11, 0.12));
            border-right-color: rgba(245, 158, 11, 0.28);
        }

        @keyframes stockLowWipe {
            0% { background-position: 0 0; }
            100% { background-position: 18px 0; }
        }

        .stock-pill.meter.lvl-low {
            border-color: rgba(239, 68, 68, 0.55);
            color: rgba(127, 29, 29, 0.95);
        }

        .stock-pill.meter.lvl-low .fill {
            background: repeating-linear-gradient(
                135deg,
                rgba(239, 68, 68, 0.22) 0,
                rgba(239, 68, 68, 0.22) 6px,
                rgba(239, 68, 68, 0.12) 6px,
                rgba(239, 68, 68, 0.12) 12px
            );
            background-size: 18px 18px;
            animation: stockLowWipe 1.2s linear infinite;
            border-right-color: rgba(239, 68, 68, 0.24);
        }

        .stock-pill.meter.lvl-out {
            background: transparent;
            border-style: dashed;
            border-color: rgba(100, 116, 139, 0.45);
            color: rgba(100, 116, 139, 0.55);
        }

        .stock-pill.meter.lvl-out .fill {
            width: 100% !important;
            background: repeating-linear-gradient(
                135deg,
                rgba(100, 116, 139, 0.10) 0,
                rgba(100, 116, 139, 0.10) 7px,
                rgba(100, 116, 139, 0.04) 7px,
                rgba(100, 116, 139, 0.04) 14px
            );
            background-size: 18px 18px;
            border-right: none;
            opacity: 0.55;
        }

        @keyframes stockCtaPulse {
            0%, 100% { transform: translateY(0); box-shadow: 0 10px 22px rgba(34, 197, 94, 0.22); }
            50% { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(34, 197, 94, 0.30); }
        }

        .stock-pill.cta {
            color: #052e16;
            border-color: rgba(34, 197, 94, 0.65);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.18), rgba(34, 197, 94, 0.10));
            box-shadow: 0 10px 22px rgba(34, 197, 94, 0.22);
            animation: stockCtaPulse 2.2s ease-in-out infinite;
        }

        .stock-pill.empty {
            border-color: transparent;
            color: transparent;
        }

        .stock-signal {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 800;
            line-height: 1.2;
            border: 1px solid rgba(148, 163, 184, 0.55);
            color: rgba(100, 116, 139, 0.9);
            min-width: 74px;
            justify-content: center;
            background: transparent;
        }

        .stock-signal.cta {
            color: #052e16;
            border-color: rgba(34, 197, 94, 0.65);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.18), rgba(34, 197, 94, 0.10));
            box-shadow: 0 10px 22px rgba(34, 197, 94, 0.22);
            animation: stockCtaPulse 2.2s ease-in-out infinite;
        }

        .stock-signal i {
            font-size: 0.75rem;
            opacity: 0.95;
        }

        .stock-signal.empty {
            border-color: transparent;
            color: transparent;
        }

        .availability-bar {
            margin-top: 4px;
            height: 6px;
            border-radius: 999px;
            background: rgba(100, 116, 139, 0.15);
            overflow: hidden;
            display: flex;
            gap: 2px;
        }

        .availability-bar .seg {
            flex: 1;
            background: rgba(100, 116, 139, 0.12);
        }

        .availability-bar .seg.on {
            background: rgba(34, 197, 94, 0.85);
        }

        .availability-bar .seg.on.blue {
            background: rgba(59, 130, 246, 0.85);
        }

        @keyframes cartBadgePop {
            0% { transform: scale(1); }
            45% { transform: scale(1.22); }
            100% { transform: scale(1); }
        }

        @keyframes cartBadgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .cart-count.pop {
            animation: cartBadgePop 180ms ease-out;
        }

        .cart-count.has-items {
            animation: cartBadgePulse 1.4s ease-in-out infinite;
        }

        .stock-location {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .stock-location span:first-child {
            color: var(--gray);
        }

        .stock-high {
            color: var(--success);
            font-weight: 600;
        }

        .stock-medium {
            color: var(--warning);
            font-weight: 600;
        }

        .stock-low {
            color: var(--danger);
            font-weight: 600;
        }

        .price-info {
            text-align: center;
        }

        .price-value {
            font-weight: 800;
            color: var(--primary);
            font-size: 0.82rem;
            padding: 0;
            border-radius: 0;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .currency-symbol {
            margin-left: 4px;
            font-weight: 600;
        }

        .tl-symbol {
            color: #e30a17;
        }

        .eur-symbol {
            color: #003399;
        }

        .usd-symbol {
            color: #3c3b6e;
        }

        .gbp-symbol {
            color: #c8102e;
        }

        .discount-info {
            text-align: center;
        }

        .discount-compact {
            font-size: 0.82rem;
            font-weight: 800;
            color: var(--dark);
            opacity: 0.9;
            white-space: nowrap;
        }

        .discount-badges {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            align-items: center;
        }

        .discount-item {
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            min-width: 50px;
            text-align: center;
        }

        .discount-5 {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .discount-20 {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .discount-40 {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .discount-other {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .tax-included-price {
            text-align: center;
            font-weight: 700;
            color: var(--success);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .cart-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--gray-light);
            background: white;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            color: var(--dark);
            font-size: 0.8rem;
        }

        .qty-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .qty-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qty-input {
            width: 45px;
            height: 28px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .add-to-cart {
            position: relative;
        }

        .item-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: white;
            color: var(--danger);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            border: 1px solid var(--danger);
            transform: translateZ(0);
        }

        .item-count.has-items {
            background: var(--success);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.85);
        }

        @keyframes itemCountPop {
            0% { transform: scale(1); }
            45% { transform: scale(1.18); }
            100% { transform: scale(1); }
        }

        .item-count.pop {
            animation: itemCountPop 160ms ease-out;
        }

        .add-to-cart {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .add-to-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .loading, .empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--gray);
            grid-column: 1 / -1;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            min-height: 45vh;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-light);
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            max-width: 400px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .search-slider-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .nav-menu {
                flex-direction: row;
                overflow-x: auto;
                padding: 0 1rem 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .exchange-rates-box {
                min-width: 100%;
            }
            
            .exchange-rates {
                gap: 1rem;
            }
            
            .page-content {
                padding: 1rem;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .advanced-filters {
                grid-template-columns: 1fr;
            }
        }

        .search-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .search-header.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .search-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 5px;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-info {
            background: #3498db;
            color: white;
        }
        
        .badge-warning {
            background: #ff9800;
            color: white;
        }
        
        .group-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f5f7fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .group-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-title h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .item-count {
            background: #d82626;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .btn-toggle-group {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }
        
        .btn-toggle-group:hover {
            background: #f0f0f0;
        }
        
        .group-summary {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sample-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .sample-info strong {
            font-size: 14px;
            color: #333;
        }
        
        .manufacturer {
            font-size: 12px;
            color: #666;
        }
        
        .group-price-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .price {
            font-size: 16px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .discount-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .group-items-container {
            padding: 0 15px 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }
        
        .group-items-header {
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .group-items-header h5 {
            margin: 0 0 5px 0;
            color: #555;
            font-size: 14px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .fallback-results {
            display: grid;
            gap: 10px;
            padding: 20px 0;
        }
        
        .product-item {
            background: white;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-store"></i> B2B<span>TRADE</span></h1>
            </div>
            <div class="customer-info">
                <div class="customer-name" id="customer-name">Yükleniyor...</div>
                <div class="customer-code" id="customer-code">Müşteri Kodu: Yükleniyor...</div>
            </div>
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item active">
                    <i class="fas fa-home"></i> Anasayfa
                </a>
                <a href="sepetim.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i> Sepetim
                </a>
                <a href="kampanya-sepeti.html" class="nav-item">
                    <i class="fas fa-tags"></i> Kampanya Sepetim
                </a>
                <a href="sanal-pos.html" class="nav-item">
                    <i class="fas fa-credit-card"></i> Sanal Pos Ödeme
                </a>
                <a href="cari-hesap.html" class="nav-item">
                    <i class="fas fa-file-invoice-dollar"></i> Cari Hesabım
                </a>
                <a href="siparis-gecmisi.html" class="nav-item">
                    <i class="fas fa-clipboard-list"></i> Sipariş Geçmişim
                </a>
                <a href="iade-islemleri.html" class="nav-item">
                    <i class="fas fa-undo-alt"></i> İade İşlemlerim
                </a>
                <a href="musteri-hizmetleri.html" class="nav-item">
                    <i class="fas fa-headset"></i> Müşteri Hizmetleri
                </a>
                <a href="hesap-ayarlari.html" class="nav-item">
                    <i class="fas fa-user-cog"></i> Hesap Ayarları
                </a>
                <a href="#" class="nav-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="welcome-section">
                    <div class="welcome-icon">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="welcome-text">
                        <h1 id="welcome-title">Hoş Geldiniz!</h1>
                    </div>
                </div>
                
                <div class="exchange-rates-container">
                    <div class="exchange-rates-simple" id="exchange-rates-simple">
                        <div class="exchange-rates-row">
                            <span class="currency-badge eur-badge">
                                <span class="currency-symbol">€</span>
                                <span class="currency-code">EUR</span>
                                <span class="rate-value" id="eur-rate">49,45</span>
                            </span>
                            <div class="exchange-divider"></div>
                            <span class="currency-badge usd-badge">
                                <span class="currency-symbol">$</span>
                                <span class="currency-code">USD</span>
                                <span class="rate-value" id="usd-rate">42,43</span>
                            </span>
                        </div>
                        <div class="exchange-source-mini" id="exchange-source-mini">
                            <i class="fas fa-clock"></i>
                            <span id="tcmb-source">TCMB - Son Güncelleme</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <a href="sepetim.html" class="cart-indicator" id="cart-indicator">
                        <i class="fas fa-shopping-cart"></i> Sepetim
                        <span class="cart-count" id="cart-count">0</span>
                    </a>
                </div>
            </header>

            <div class="page-content">
                <div class="search-slider-container">
                    <div class="search-section">
                        <div class="search-header">
                            <h2 class="search-title">
                                <i class="fas fa-search"></i> Malzeme Ara
                            </h2>
                        </div>
                        <form class="search-form" id="search-form">
                            <input type="text" class="search-input" id="search-input" 
                                   placeholder="Malzeme kodu veya OEM kodu ara...">
                            <button class="search-btn" id="search-button">
                            <i class="fas fa-search"></i>
                            Ara
                        </button>
                    </form>

                    <!-- ARAMA SONUÇLARI ALANI - smart search sonuçlarının gösterimi -->
                    <div id="search-results-section" class="mt-4" style="display: none; margin-top: 20px;">
                        <div class="card shadow-sm" style="border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                            <div class="card-header bg-light border-bottom py-2" style="background: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px 8px 0 0;">
                                <h6 class="mb-0 text-primary" style="margin: 0; font-size: 14px; color: #2563eb;">
                                    <i class="fas fa-search me-2" style="margin-right: 6px;"></i>
                                    <span id="search-results-title">Arama Sonuçları</span>
                                    <small class="text-muted ms-2" style="margin-left: 8px; color: #6b7280;">
                                        (<span id="search-results-count">0</span> sonuç)
                                    </small>
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="search-results-list" class="list-group list-group-flush">
                                    <!-- Sonuçlar buraya JavaScript ile eklenecek -->
                                </div>
                            </div>
                            <div class="card-footer bg-white border-top py-2" style="background: #ffffff; border-top: 1px solid #e5e7eb; padding: 6px 12px; border-radius: 0 0 8px 8px;">
                                <div class="text-end small text-muted" style="text-align: right; font-size: 12px; color: #9ca3af;">
                                    <span id="search-time">0ms</span> içinde tamamlandı
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Akıllı arama sonuç alanı -->
                    <div id="results-container" class="mt-4" style="display: none; margin-top: 20px;">
                        <div class="card border-primary" style="border-radius: 8px; border: 1px solid #2563eb; background: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                            <div class="card-header bg-primary text-white py-2" style="background: #2563eb; color: white; padding: 8px 12px; border-radius: 8px 8px 0 0;">
                                <h6 class="mb-0" style="margin: 0; font-size: 14px;"><i class="fas fa-search" style="margin-right: 6px;"></i>Arama Sonuçları</h6>
                            </div>
                            <div class="card-body p-3" style="padding: 12px;">
                                <div id="results-list">
                                    <!-- Sonuçlar buraya JavaScript ile eklenecek -->
                                </div>
                                <div class="text-muted small mt-2" id="results-info" style="margin-top: 8px; font-size: 12px; color: #666;">
                                    <span id="results-count">0</span> sonuç bulundu
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-toggle-row">
                        <button type="button" class="filter-toggle-btn" id="open-filters-btn">
                            <i class="fas fa-sliders-h"></i>
                            Filtreler
                        </button>
                        <button type="button" class="btn-secondary" id="quick-clear-filters-btn">Temizle</button>
                        <div class="filter-chip-row" id="filter-chips"></div>
                    </div>
                    <div class="filter-modal-backdrop" id="filter-modal-backdrop" aria-hidden="true">
                        <div class="filter-modal" role="dialog" aria-modal="true" aria-labelledby="filter-modal-title">
                            <div class="filter-modal-header">
                                <div class="filter-modal-title" id="filter-modal-title">
                                    <i class="fas fa-filter"></i>
                                    Filtreler
                                </div>
                                <button class="filter-modal-close" type="button" id="close-filters-btn">×</button>
                            </div>
                            <div class="filter-modal-body">
                                <div class="filter-panel">
                                    <div class="filter-panel-head">
                                        <strong><i class="fas fa-industry"></i> Üretici</strong>
                                        <span id="manufacturer-selected-count">0</span>
                                    </div>
                                    <div class="filter-search">
                                        <input type="text" id="manufacturer-search" placeholder="Üretici ara...">
                                    </div>
                                    <div class="filter-list" id="manufacturer-list"></div>
                                </div>
                                <div class="filter-panel">
                                    <div class="filter-panel-head">
                                        <strong><i class="fas fa-car"></i> Araç Modeli</strong>
                                        <span id="vehicle-selected-count">0</span>
                                    </div>
                                    <div class="filter-search">
                                        <input type="text" id="vehicle-search" placeholder="Araç modeli ara...">
                                    </div>
                                    <div class="filter-list" id="vehicle-list"></div>
                                </div>
                            </div>
                            <div class="filter-modal-footer">
                                <div id="filter-footer-info"></div>
                                <div class="filter-footer-actions">
                                    <button type="button" class="btn-secondary" id="clear-filters-btn">Temizle</button>
                                    <button type="button" class="btn-primary" id="apply-filters-btn">Uygula</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider" id="slider">
                            <div class="slide" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                B2B ÖZEL KAMPANYALAR - %40'A VARAN İNDİRİMLER
                            </div>
                            <div class="slide" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                4 KATMANLI İSKONTO SİSTEMİ
                            </div>
                            <div class="slide" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                                MÜŞTERİ ÖZEL FİYATLARINIZ HAZIR
                            </div>
                        </div>
                        <div class="slider-controls">
                            <div class="slider-dot active" data-slide="0"></div>
                            <div class="slider-dot" data-slide="1"></div>
                            <div class="slider-dot" data-slide="2"></div>
                        </div>
                    </div>
                </div>

                <div class="products-section">
                    <div class="section-header">
                        <div class="table-meta" id="table-meta"></div>
                        <div class="table-meta" id="pagination-meta" style="margin-left:auto; display:flex; gap:10px; align-items:center; justify-content:flex-end;"></div>
                    </div>
                    
                    <div class="products-table-container" id="tableView">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Malzeme Kodu</th>
                                    <th>Ürün Adı</th>
                                    <th>OEM Kodu</th>
                                    <th>Üretici</th>
                                    <th>Stok Durumu</th>
                                    <th>Fiyat</th>
                                    <th>İskonto</th>
                                    <th>KDV Dahil</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <tr>
                                    <td colspan="10" class="empty-state">
                                        <i class="fas fa-search"></i>
                                        <div>Arama yapın veya filtre seçin</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Ürün sepete eklendi!</span>
    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];
        let currentUser = null;
        let currentSlide = 0;
        let sliderInterval;
        let allProducts = [];
        let displayedProducts = [];
        let showStock = true;
        let activeWarehouses = [1, 2];
        let tcmbRates = { EUR: 49.45, USD: 42.43 };
        let exchangeRatesInterval = null;

        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const productsTableBody = document.getElementById('products-table-body');
        const notification = document.getElementById('notification');
        const slider = document.getElementById('slider');
        const sliderDots = document.querySelectorAll('.slider-dot');
        const cartIndicator = document.getElementById('cart-indicator');
        const cartCountElement = document.getElementById('cart-count');
        const customerNameEl = document.getElementById('customer-name');
        const customerCodeEl = document.getElementById('customer-code');
        const welcomeTitleEl = document.getElementById('welcome-title');
        const eurRateEl = document.getElementById('eur-rate');
        const usdRateEl = document.getElementById('usd-rate');
        const tcmbSourceEl = document.getElementById('tcmb-source');
        const manufacturerFilterEl = document.getElementById('manufacturer-filter');
        const vehicleFilterEl = document.getElementById('vehicle-filter');
        const openFiltersBtn = document.getElementById('open-filters-btn');
        const closeFiltersBtn = document.getElementById('close-filters-btn');
        const filterModalBackdrop = document.getElementById('filter-modal-backdrop');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const filterChipsEl = document.getElementById('filter-chips');
        const manufacturerListEl = document.getElementById('manufacturer-list');
        const vehicleListEl = document.getElementById('vehicle-list');
        const manufacturerSearchEl = document.getElementById('manufacturer-search');
        const vehicleSearchEl = document.getElementById('vehicle-search');
        const manufacturerSelectedCountEl = document.getElementById('manufacturer-selected-count');
        const vehicleSelectedCountEl = document.getElementById('vehicle-selected-count');
        const quickClearFiltersBtn = document.getElementById('quick-clear-filters-btn');
        let lastSearchTerm = '';

        let manufacturersAll = [];
        let vehicleModelsAll = [];
        let selectedManufacturers = [];
        let selectedVehicleModels = [];

        let hasSearched = false;

        let currentPage = 0;
        const pageSize = 50;
        let lastTotalResults = 0;

        function getLastSearchStorageKey() {
            const code = currentUser && (currentUser.cari_kodu || currentUser.customerCode || currentUser.kullanici);
            return `b2b_last_search_state_${String(code || 'anon')}`;
        }

        function saveLastSearchState() {
            try {
                const key = getLastSearchStorageKey();
                const payload = {
                    query: (searchInput && searchInput.value) ? String(searchInput.value) : '',
                    manufacturerCodes: Array.isArray(selectedManufacturers) ? selectedManufacturers : [],
                    vehicleModels: Array.isArray(selectedVehicleModels) ? selectedVehicleModels : [],
                    page: Number.isFinite(Number(currentPage)) ? Number(currentPage) : 0,
                    ts: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(payload));
            } catch (e) {
            }
        }

        function clearLastSearchState() {
            try {
                localStorage.removeItem(getLastSearchStorageKey());
            } catch (e) {
            }
        }

        function restoreLastSearchState() {
            try {
                const raw = localStorage.getItem(getLastSearchStorageKey());
                if (!raw) return false;
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') return false;

                const q = String(parsed.query || '');
                const m = Array.isArray(parsed.manufacturerCodes) ? parsed.manufacturerCodes : [];
                const v = Array.isArray(parsed.vehicleModels) ? parsed.vehicleModels : [];
                const p = Number.isFinite(Number(parsed.page)) ? Number(parsed.page) : 0;

                if (searchInput) searchInput.value = q;
                selectedManufacturers = m.map(x => String(x || '').trim()).filter(Boolean);
                selectedVehicleModels = v.map(x => String(x || '').trim()).filter(Boolean);
                currentPage = Math.max(0, p);

                renderFilterLists();
                renderFilterChips();
                return true;
            } catch (e) {
                return false;
            }
        }

        async function restoreLastResultsButClearFilters() {
            try {
                const raw = localStorage.getItem(getLastSearchStorageKey());
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') return;

                const q = String(parsed.query || '').trim();
                const m = Array.isArray(parsed.manufacturerCodes) ? parsed.manufacturerCodes : [];
                const v = Array.isArray(parsed.vehicleModels) ? parsed.vehicleModels : [];
                const p = Number.isFinite(Number(parsed.page)) ? Number(parsed.page) : 0;

                if (searchInput) searchInput.value = q;
                currentPage = Math.max(0, p);

                const restoredManufacturers = m.map(x => String(x || '').trim()).filter(Boolean);
                const restoredVehicles = v.map(x => String(x || '').trim()).filter(Boolean);

                if (!q && restoredManufacturers.length === 0 && restoredVehicles.length === 0) {
                    return;
                }

                // Perform search using restored filters, but do not persist them again.
                await performSearch({
                    manufacturerCodes: restoredManufacturers,
                    vehicleModels: restoredVehicles,
                    page: currentPage,
                    skipSave: true,
                    force: true
                });

                // Clear filters every time user returns.
                selectedManufacturers = [];
                selectedVehicleModels = [];
                renderFilterLists();
                renderFilterChips();
            } catch (e) {
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function encodeUserDataToBase64(userData) {
            try {
                const jsonString = JSON.stringify(userData);
                return btoa(unescape(encodeURIComponent(jsonString)));
            } catch (error) {
                console.error('Base64 encode hatası:', error);
                return '';
            }
        }

        function setAuthHeaders(userType = 'customer') {
            try {
                const userDataString = localStorage.getItem('b2b_user_data');
                if (userDataString) {
                    const userData = JSON.parse(userDataString);
                    const userDataBase64 = encodeUserDataToBase64(userData);
                    
                    return {
                        'Content-Type': 'application/json',
                        'x-user-data-base64': userDataBase64,
                        'x-user-type': userType
                    };
                }
                return { 'Content-Type': 'application/json' };
            } catch (error) {
                console.error('Auth header oluşturma hatası:', error);
                return { 'Content-Type': 'application/json' };
            }
        }

        async function initializeApp() {
            try {
                await loadUserData();
                displayCustomerInfo();
                await loadExchangeRates();
                await loadFilters();
                startExchangeRatesAutoUpdate();
                setupEventListeners();
                startSlider();
                updateCartCount();
                updateAllItemCounts();

                await restoreLastResultsButClearFilters();
                
            } catch (error) {
                console.error('Uygulama başlatma hatası:', error);
                showError('Uygulama başlatılamadı: ' + error.message);
            }
        }

        async function loadUserData() {
            try {
                const userDataString = localStorage.getItem('b2b_user_data');
                
                if (!userDataString) {
                    window.location.href = '/';
                    return;
                }

                const userData = JSON.parse(userDataString);
                currentUser = userData;
                
            } catch (error) {
                console.error('Kullanıcı bilgisi yükleme hatası:', error);
                throw new Error('Kullanıcı bilgileri alınamadı');
            }
        }

        function displayCustomerInfo() {
            if (!currentUser) {
                customerNameEl.textContent = 'Müşteri Bulunamadı';
                customerCodeEl.textContent = 'Müşteri Kodu: -';
                return;
            }

            const customerName = currentUser.musteri_adi || currentUser.kullanici || 'Müşteri';
            const customerCode = currentUser.cari_kodu || currentUser.kullanici || '-';
            
            customerNameEl.textContent = customerName;
            customerCodeEl.textContent = `Müşteri Kodu: ${customerCode}`;
            welcomeTitleEl.textContent = `Hoş Geldiniz, ${customerName}!`;
        }

        async function loadB2BProducts() {
            try {
                if (!currentUser || !currentUser.cari_kodu) {
                    console.warn('Müşteri kodu bulunamadı');
                    showError('Müşteri bilgisi bulunamadı. Lütfen tekrar giriş yapın.');
                    return;
                }

                const customerCode = currentUser.cari_kodu;
                console.log(`🔄 B2B API ürünleri yükleniyor: ${customerCode}`);
                
                const userDataBase64 = encodeUserDataToBase64(currentUser);
                
                const response = await fetch(`/api/b2b/products?customerCode=${encodeURIComponent(customerCode)}&limit=100`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-data-base64': userDataBase64,
                        'x-user-type': 'customer'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`B2B API hatası: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'B2B verisi alınamadı');
                }

                console.log(`✅ B2B API verileri alındı: ${result.data?.length || 0} ürün`);
                
                if (result.data && Array.isArray(result.data)) {
                    if (typeof result.show_stock === 'boolean') {
                        showStock = result.show_stock;
                    }
                    if (Array.isArray(result.active_warehouses)) {
                        activeWarehouses = result.active_warehouses;
                    }
                    allProducts = result.data;

                    renderB2BProducts(allProducts);
                    updateAllItemCounts();
                } else {
                    throw new Error('Geçersiz veri formatı');
                }
                
            } catch (error) {
                console.error('B2B ürün yükleme hatası:', error);
                showError('Ürünler yüklenemedi: ' + error.message);
            }
        }

        

        function renderB2BProducts(products) {
            displayedProducts = Array.isArray(products) ? products : [];
            if (!products || products.length === 0) {
                productsTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas ${hasSearched ? 'fa-box-open' : 'fa-search'}"></i>
                            <div>${hasSearched ? 'Sonuç bulunamadı' : 'Arama yapın veya filtre seçin'}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            productsTableBody.innerHTML = products.map(product => {
                const productCode = product.productCode || product.code || '-';
                const productCodeDom = safeDomId(productCode);
                const productName = product.productName || product.name || 'İsimsiz Ürün';
                const oemCode = product.oemCode || '-';
                const manufacturer = product.manufacturer || 'Belirtilmemiş';
                const centralStock = product.centralStock || 0;
                const ikitelliStock = product.ikitelliStock || 0;
                const bostanciStock = product.bostanciStock || 0;
                const depotStock = product.depotStock || 0;
                const unitPrice = product.unitPrice || 0;
                const currencyCode = product.currencyCode || 160;
                const finalPrice = product.finalPrice || unitPrice;
                const discountRate = product.totalDiscountRate || product.discountRate || 0;
                const discounts = product.discounts || [];
                const discountRates = (Array.isArray(discounts) ? discounts : [])
                    .map(d => Number(d.rate || 0))
                    .filter(r => r > 0);

                const discountedNetUnitPrice = applySequentialDiscounts(unitPrice, discountRates);
                const taxIncludedPrice = discountedNetUnitPrice * 1.20;
                const taxIncludedPriceTry = convertToTry(taxIncludedPrice, currencyCode);

                const warehouseDefs = {
                    0: { label: 'Merkez', value: centralStock, className: 'central' },
                    1: { label: 'İkitelli', value: ikitelliStock, className: 'ikitelli' },
                    2: { label: 'Bostancı', value: bostanciStock, className: 'bostanci' },
                    3: { label: 'Depo', value: depotStock, className: 'depot' }
                };

                const activeList = Array.isArray(activeWarehouses) && activeWarehouses.length > 0 ? activeWarehouses : [1, 2];
                const totalActiveStock = activeList
                    .filter(inv => warehouseDefs[inv])
                    .reduce((sum, inv) => sum + (Number(warehouseDefs[inv].value) || 0), 0);
                const activeLocationsHtml = activeList
                    .filter(inv => warehouseDefs[inv])
                    .map(inv => {
                        const w = warehouseDefs[inv];
                        const val = Number(w.value) || 0;
                        const level = val >= 50 ? 'high' : (val >= 10 ? 'medium' : (val > 0 ? 'low' : 'out'));
                        const fill = val >= 50 ? 100 : (val >= 10 ? 72 : (val >= 5 ? 52 : (val >= 1 ? 28 : 0)));
                        return `
                            <div class="stock-location">
                                <span>${w.label}:</span>
                                ${showStock
                                    ? `<span class="stock-pill meter lvl-${level}" style="--fill: ${fill}%" aria-label="${w.label} stok ${val}"><span class="fill"></span><span class="txt">${val}</span></span>`
                                    : (val > 0
                                        ? `<span class="stock-signal cta">
                                                <i class="fas fa-bolt"></i>
                                                <span>Stokta Var</span>
                                           </span>`
                                        : `<span class="stock-signal empty"></span>`)}
                            </div>
                        `;
                    })
                    .join('');

                const activeBarHtml = showStock ? '' : `
                    <div class="availability-bar" aria-hidden="true">
                        ${activeList
                            .filter(inv => warehouseDefs[inv])
                            .map(inv => {
                                const w = warehouseDefs[inv];
                                const val = Number(w.value) || 0;
                                const onClass = val > 0 ? 'on' : '';
                                const colorClass = (w.className === 'bostanci') ? 'blue' : '';
                                return `
                                    <span class="seg ${onClass} ${colorClass}"></span>
                                    <span class="seg ${onClass} ${colorClass}"></span>
                                `;
                            })
                            .join('')}
                    </div>
                `;
                
                return `
                <tr class="${product.hasCampaign ? 'campaign-row' : ''} ${totalActiveStock > 0 ? 'in-stock-found' : ''}">
                    <td>
                        <div class="product-image">
                            <i class="fas fa-box"></i>
                        </div>
                    </td>
                    <td class="product-code">${productCode}</td>
                    <td>
                        <div class="product-name">
                            ${productName}
                        </div>
                        ${product.hasCampaign ? '<span class="campaign-badge">Kampanya</span>' : ''}
                    </td>
                    <td>${oemCode}</td>
                    <td><span class="manufacturer-badge">${manufacturer}</span></td>
                    <td>
                        <div class="stock-info">
                            ${activeLocationsHtml}
                            ${activeBarHtml}
                        </div>
                    </td>
                    <td class="price-info">
                        <div class="price-value">
                            ${formatPriceWithSymbol(unitPrice, currencyCode)}
                        </div>
                    </td>
                    <td class="discount-info">
                        <span class="discount-compact">${getDiscountBadgesHTML(discounts, discountRate)}</span>
                    </td>
                    <td class="tax-included-price">
                        ${formatPriceWithSymbol(taxIncludedPriceTry, 160)}
                    </td>
                    <td>
                        <div class="cart-actions">
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="updateProductQuantity('${productCode}', -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="qty-input" id="qty-${productCodeDom}" 
                                    value="1" 
                                    min="1" 
                                    max="999">
                                <button class="qty-btn" onclick="updateProductQuantity('${productCode}', 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <button class="add-to-cart" onclick="handleCartClick(event, '${productCode}')" oncontextmenu="handleCartClick(event, '${productCode}')" title="Sepete Ekle">
                                <i class="fas fa-cart-plus"></i>
                                <span class="item-count" id="item-count-${productCodeDom}">0</span>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function getStockClass(stock) {
            if (stock >= 50) return 'high';
            if (stock >= 10) return 'medium';
            return 'low';
        }

        function applySequentialDiscounts(baseAmount, rates) {
            let current = Number(baseAmount) || 0;
            (Array.isArray(rates) ? rates : [])
                .map(r => Number(r) || 0)
                .filter(r => r > 0)
                .forEach((rate) => {
                    current = current * (1 - (rate / 100));
                });

            return Number((Number.isFinite(current) ? current : 0).toFixed(2));
        }

        function getDiscountBadgesHTML(discounts, discountRate) {
            const rates = (Array.isArray(discounts) ? discounts : [])
                .map(d => Number(d.rate || 0))
                .filter(r => r > 0);

            if (rates.length > 0) {
                return `${rates[0]}${rates.slice(1).map(r => `+${r}`).join('')} %`;
            }

            if (Number(discountRate || 0) > 0) {
                return `${Number(discountRate)} %`;
            }

            return '-';
        }

        function displaySmartSearchResults(data) {
            console.log('📊 Arama sonuçları işleniyor (sadece ana tablo):', data);

            // Backend response'undan toplam sonucu al
            const totalResults =
                (typeof data.sonuç === 'number' ? data.sonuç : undefined) ??
                (typeof data.total_results === 'number' ? data.total_results : 0);

            // Hiç sonuç yoksa ana tabloyu boşalt
            if (!totalResults) {
                renderB2BProducts([]);
                const metaEl = document.getElementById('table-meta');
                if (metaEl) metaEl.textContent = '';
                return;
            }

            if (typeof data.show_stock === 'boolean') {
                showStock = data.show_stock;
            }

            if (Array.isArray(data.active_warehouses)) {
                activeWarehouses = data.active_warehouses;
            }

            let products = [];
            if (data.ürünler && Array.isArray(data.ürünler)) {
                products = data.ürünler.map(p => ({
                    code: p.kod,
                    name: p.ad,
                    oemCode: p.oem_kodu,
                    manufacturer: p.uretici,
                    unitPrice: p.fiyat || 0,
                    currencyCode: Number(p.currencyCode || p.currency_code || 160),
                    ikitelliStock: Number(p.ikitelliStock || 0),
                    bostanciStock: Number(p.bostanciStock || 0),
                    finalPrice: p.fiyat || 0,
                    totalDiscountRate: 0,
                    discounts: []
                }));
            } else if (data.results && Array.isArray(data.results)) {
                data.results.forEach(group => {
                    if (group.items && Array.isArray(group.items)) {
                        group.items.forEach(item => {
                            products.push({
                                code: item.item_code || group.sample_item_code || 'KOD',
                                name: group.sample_manufacturer || 'Ürün',
                                oemCode: item.manufacturer_code || '',
                                manufacturer: group.sample_manufacturer || '',
                                unitPrice: item.customer_price ? (item.customer_price.price || 0) : 0,
                                currencyCode: Number(
                                    item.currencyCode ||
                                    item.currency_code ||
                                    (item.customer_price ? (item.customer_price.currency_code || item.customer_price.currencyCode) : undefined) ||
                                    160
                                ),
                                ikitelliStock: (item.stock_info && item.stock_info.total_stock > 0) ? 1 : 0,
                                bostanciStock: 0,
                                finalPrice: item.customer_price ? (item.customer_price.price || 0) : 0,
                                totalDiscountRate: item.customer_price ? (item.customer_price.discount_rate || 0) : 0,
                                discounts: []
                            });
                        });
                    }
                });
            }

            products.sort((a, b) => {
                const aStock = Number(a.ikitelliStock || 0) + Number(a.bostanciStock || 0);
                const bStock = Number(b.ikitelliStock || 0) + Number(b.bostanciStock || 0);
                return bStock - aStock;
            });

            // Global ürün listesini güncelle ve ana tabloyu yeniden çiz
            allProducts = products;
            renderB2BProducts(allProducts);
            updateAllItemCounts();

            const metaEl = document.getElementById('table-meta');
            if (metaEl) {
                const ms = Number(data.response_time_ms || 0);
                const seconds = ms ? (ms / 1000).toFixed(2) : '';
                metaEl.textContent = seconds ? `${totalResults} ürün · ${seconds}s` : `${totalResults} ürün`;
            }

            // Eski "arama altında özellikler" bölümünü tamamen gizle (varsa)
            const resultsSection = document.getElementById('search-results-section');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
        }

        function createSearchResultsContainer() {
            const existing = document.getElementById('search-results-section');
            if (existing) return;
            
            const containerHTML = `
                <div id="search-results-section" class="mt-4" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-bottom py-2">
                            <h6 class="mb-0 text-primary">
                                <i class="fas fa-search me-2"></i>
                                <span id="search-results-title">Arama Sonuçları</span>
                                <small class="text-muted ms-2">(<span id="search-results-count">0</span> sonuç)</small>
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="search-results-list" class="list-group list-group-flush"></div>
                        </div>
                        <div class="card-footer bg-white border-top py-2">
                            <div class="text-end small text-muted">
                                <span id="search-time">0ms</span> içinde tamamlandı
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.insertAdjacentHTML('afterend', containerHTML);
                console.log('⚠️ Acil: search-results-section oluşturuldu ve eklendi');
            } else {
                document.body.insertAdjacentHTML('beforeend', containerHTML);
            }
        }

        // Basit sepete ekleme fonksiyonu (UI testi için)
        function addToCart(productCode) {
            console.log('🛒 Sepete eklendi:', productCode);
            alert(`"${productCode}" sepete eklendi!`);
        }

        function createGroupCard(group, groupIndex) {
            const groupId = group.group_id || `GRP_${groupIndex}`;
            const itemCount = group.item_count || 0;
            const sampleCode = group.sample_item_code || 'Örnek Kod';
            const manufacturer = group.sample_manufacturer || 'Üretici';
            
            let priceInfo = '';
            let discountInfo = '';
            
            if (group.items && group.items.length > 0) {
                const firstItem = group.items[0];
                
                if (firstItem.customer_price) {
                    const price = firstItem.customer_price.price || 0;
                    const currency = firstItem.customer_price.currency || 'TL';
                    priceInfo = `<div class="price">${price.toFixed(2)} ${currency}</div>`;
                }
                
                if (firstItem.customer_price && firstItem.customer_price.discount_rate) {
                    discountInfo = `<span class="discount-badge">-%${firstItem.customer_price.discount_rate}</span>`;
                }
            }
            
            return `
                <div class="group-card" data-group-id="${groupId}">
                    <div class="group-header">
                        <div class="group-title">
                            <h4>${groupId}</h4>
                            <span class="item-count">${itemCount} ürün</span>
                        </div>
                        <div class="group-actions">
                            <button class="btn-toggle-group" data-group-id="${groupId}">
                                <i class="expand-icon">▼</i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="group-summary">
                        <div class="sample-info">
                            <strong>${sampleCode}</strong>
                            <span class="manufacturer">${manufacturer}</span>
                        </div>
                        <div class="group-price-info">
                            ${priceInfo}
                            ${discountInfo}
                        </div>
                    </div>
                    
                    <div class="group-items-container" id="items-${groupId}" style="display: none;">
                        <div class="group-items-header">
                            <h5>Grup Ürünleri (${itemCount})</h5>
                            <small>Kodlar: ${group.normalized_codes || 'Bulunamadı'}</small>
                        </div>
                        <div class="group-items-list" id="list-${groupId}">
                        </div>
                    </div>
                </div>
            `;
        }

        function displayFallbackResults(result, searchTerm) {
            const container = document.getElementById('results-container');
            if (!container) return;
            
            let html = `
                <div class="search-header warning">
                    <h3>"${searchTerm}" için fallback arama sonuçları</h3>
                    <div class="search-meta">
                        <span class="badge badge-warning">⚠️ Eski Sistem</span>
                        <small>Akıllı arama geçici olarak kullanılamıyor</small>
                    </div>
                </div>
            `;
            
            if (result.data && result.data.length > 0) {
                html += `<div class="fallback-results">`;
                
                result.data.forEach(item => {
                    html += `
                        <div class="product-item">
                            <div class="product-code">${item.MalzemeKodu || ''}</div>
                            <div class="product-name">${item.MalzemeAdi || ''}</div>
                            <div class="product-oem">${item.OEMKodu || ''}</div>
                            <div class="product-manufacturer">${item.Uretici || ''}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="no-results">
                        <p>Fallback aramada da sonuç bulunamadı</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function convertToTry(amount, currencyCode) {
            const value = parseFloat(amount) || 0;

            if (currencyCode === 160) return value;
            if (currencyCode === 20) return value * (parseFloat(tcmbRates?.EUR) || 0);
            if (currencyCode === 1) return value * (parseFloat(tcmbRates?.USD) || 0);
            if (currencyCode === 17) return value * ((parseFloat(tcmbRates?.EUR) || 0) * 1.1);

            return value;
        }

        function formatPriceWithSymbol(price, currencyCode) {
            const priceNumber = parseFloat(price) || 0;
            const formattedPrice = priceNumber.toFixed(2).replace('.', ',');
            
            const symbols = {
                1: '$',
                20: '€',
                17: '£',
                160: '₺'
            };
            
            const symbol = symbols[currencyCode] || '₺';
            
            let symbolClass = 'currency-symbol';
            if (currencyCode === 160) symbolClass += ' tl-symbol';
            else if (currencyCode === 20) symbolClass += ' eur-symbol';
            else if (currencyCode === 1) symbolClass += ' usd-symbol';
            else if (currencyCode === 17) symbolClass += ' gbp-symbol';
            
            return `${formattedPrice} <span class="${symbolClass}">${symbol}</span>`;
        }

        function formatPrice(price, currencyCode) {
            const priceNumber = parseFloat(price) || 0;
            const formattedPrice = priceNumber.toFixed(2).replace('.', ',');
            
            const symbols = {
                1: '$',
                20: '€',
                17: '£',
                160: '₺'
            };
            
            const symbol = symbols[currencyCode] || '₺';
            
            return `${formattedPrice} ${symbol}`;
        }

        function normalizeProductCode(code) {
            return String(code || '')
                .trim()
                .toUpperCase();
        }

        function safeDomId(raw) {
            return normalizeProductCode(raw).replace(/[^A-Z0-9]+/g, '_');
        }

        function addToCartFromB2B(productCode) {
            const normalizedCode = normalizeProductCode(productCode);

            const findByCode = (list) => (Array.isArray(list) ? list : []).find(p => {
                const c = p?.productCode || p?.code;
                return normalizeProductCode(c) === normalizedCode;
            });

            const product = findByCode(displayedProducts) || findByCode(allProducts);
            
            if (!product) {
                showNotification('Ürün bulunamadı', 'error');
                return;
            }

            const quantityInput = document.getElementById(`qty-${safeDomId(productCode)}`);
            const quantity = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;
            const resolvedCode = product.productCode || product.code || productCode;

            let finalPrice = product.finalPrice || product.unitPrice || 0;
            const currencyCode = product.currencyCode || 160;

            const cartItem = {
                code: resolvedCode,
                name: product.productName || product.name,
                price: finalPrice,
                originalPrice: product.unitPrice || finalPrice,
                manufacturer: product.manufacturer || '',
                oemCode: product.oemCode || '',
                discountRate: product.totalDiscountRate || product.discountRate || 0,
                discountRates: product.discounts || [],
                quantity: quantity,
                currency: currencyCode,
                originalCurrency: currencyCode,
                minQuantity: 1,
                addedAt: new Date().toISOString(),
                customerCode: currentUser ? currentUser.cari_kodu : 'UNKNOWN',
                unitCode: 'ADET',
                ikitelliStock: product.ikitelliStock || 0,
                bostanciStock: product.bostanciStock || 0
            };

            let cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];

            const existingIndex = cart.findIndex(item => normalizeProductCode(item.code) === normalizeProductCode(resolvedCode));
            if (existingIndex > -1) {
                cart[existingIndex].quantity += quantity;
            } else {
                cart.push(cartItem);
            }

            localStorage.setItem('b2b_cart', JSON.stringify(cart));

            updateCartCount();
            updateItemCount(productCode);
            showNotification(`${cartItem.name} sepete eklendi!`);
        }

        function removeFromCartFromB2B(productCode, quantityToRemove = 1) {
            const qty = Math.max(1, parseInt(quantityToRemove) || 1);
            let cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];

            const idx = cart.findIndex(item => normalizeProductCode(item.code) === normalizeProductCode(productCode));
            if (idx === -1) {
                updateCartCount();
                updateItemCount(productCode);
                return;
            }

            cart[idx].quantity = (parseInt(cart[idx].quantity) || 0) - qty;
            if (cart[idx].quantity <= 0) {
                cart.splice(idx, 1);
            }

            localStorage.setItem('b2b_cart', JSON.stringify(cart));
            updateCartCount();
            updateItemCount(productCode);
        }

        function handleCartClick(event, productCode) {
            if (event && event.type === 'contextmenu') {
                event.preventDefault();
                removeFromCartFromB2B(productCode, 1);
                return false;
            }

            addToCartFromB2B(productCode);
            return false;
        }

        document.addEventListener('contextmenu', function(e) {
            const btn = e.target && e.target.closest ? e.target.closest('.add-to-cart') : null;
            if (btn) {
                e.preventDefault();
            }
        });

        function updateProductQuantity(productCode, change) {
            const input = document.getElementById(`qty-${safeDomId(productCode)}`);
            if (!input) return;
            const currentValue = parseInt(input.value) || 1;
            const minQuantity = parseInt(input.min) || 1;
            const newValue = Math.max(minQuantity, currentValue + change);
            
            input.value = newValue;
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            if (cartCountElement) {
                const prev = parseInt(cartCountElement.textContent) || 0;
                cartCountElement.textContent = totalItems;

                if (totalItems > 0) {
                    cartCountElement.classList.add('has-items');
                } else {
                    cartCountElement.classList.remove('has-items');
                }

                if (totalItems > prev) {
                    cartCountElement.classList.remove('pop');
                    void cartCountElement.offsetWidth;
                    cartCountElement.classList.add('pop');
                }
            }
        }

        function updateItemCount(productCode) {
            const cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];
            const normalized = normalizeProductCode(productCode);
            const cartItem = cart.find(item => normalizeProductCode(item.code) === normalized);
            const itemCountElement = document.getElementById(`item-count-${safeDomId(productCode)}`);
            
            if (itemCountElement) {
                const qty = cartItem ? cartItem.quantity : 0;
                itemCountElement.textContent = String(qty);

                if (qty > 0) {
                    itemCountElement.classList.add('has-items');
                } else {
                    itemCountElement.classList.remove('has-items');
                }

                if (qty > 0) {
                    itemCountElement.classList.remove('pop');
                    void itemCountElement.offsetWidth;
                    itemCountElement.classList.add('pop');
                }
            }
        }

        function updateAllItemCounts() {
            const cart = JSON.parse(localStorage.getItem('b2b_cart')) || [];
            const list = (Array.isArray(displayedProducts) && displayedProducts.length > 0) ? displayedProducts : allProducts;
            list.forEach(product => {
                const productCode = product.productCode || product.code;
                if (productCode) {
                    const cartItem = cart.find(item => normalizeProductCode(item.code) === normalizeProductCode(productCode));
                    const itemCountElement = document.getElementById(`item-count-${safeDomId(productCode)}`);
                    
                    if (!itemCountElement) return;

                    const qty = cartItem ? (parseInt(cartItem.quantity) || 0) : 0;
                    itemCountElement.textContent = String(qty);

                    if (qty > 0) {
                        itemCountElement.classList.add('has-items');
                    } else {
                        itemCountElement.classList.remove('has-items');
                    }
                }
            });
        }

        async function performSearch(opts = {}) {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            lastSearchTerm = searchTerm;
            
            console.log('🔍 Arama başlatılıyor:', searchTerm);
            console.log('👤 Current user:', currentUser);
            const debugHeaders = setAuthHeaders('customer');
            console.log('🔑 Auth headers:', debugHeaders);
            
            const manufacturerCodesToSend = Array.isArray(opts.manufacturerCodes) ? opts.manufacturerCodes : selectedManufacturers;
            const vehicleModelsToSend = Array.isArray(opts.vehicleModels) ? opts.vehicleModels : selectedVehicleModels;
            const pageToUse = Number.isFinite(Number(opts.page)) ? Number(opts.page) : currentPage;

            const hasAnyFilter = (manufacturerCodesToSend && manufacturerCodesToSend.length > 0) || (vehicleModelsToSend && vehicleModelsToSend.length > 0);
            if (!searchTerm && !hasAnyFilter) {
                showToast('Arama yapın veya filtre seçin', 'warning');
                return;
            }

            if (!(opts && opts.skipSave === true)) {
                saveLastSearchState();
            }
            
            if (opts && opts.silent === true) {
                showLoading({ silent: true });
            } else {
                showLoading();
            }
            console.log(`🔍 Akıllı arama başlatıldı: "${searchTerm}"`);
            
            try {
                const response = await fetch('/api/b2b/search/meili-search-enriched', {
                    method: 'POST',
                    headers: debugHeaders,
                    body: JSON.stringify({
                        query: searchTerm,
                        customerCode: currentUser.cari_kodu,
                        limit: pageSize,
                        offset: pageToUse * pageSize,
                        manufacturerCodes: manufacturerCodesToSend,
                        vehicleModels: vehicleModelsToSend
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API hatası: ${response.status}`);
                }
                
                const result = await response.json();

                if (!result || !result.success) {
                    throw new Error(result?.error || 'Arama başarısız');
                }

                const products = Array.isArray(result.results) ? result.results : [];

                hasSearched = true;
                allProducts = products;
                lastTotalResults = (typeof result.total_results === 'number') ? result.total_results : products.length;
                renderB2BProducts(allProducts);
                updateAllItemCounts();

                renderPaginationMeta();

                const metaEl = document.getElementById('table-meta');
                if (metaEl) {
                    const ms = Number(result.response_time_ms || 0);
                    const seconds = ms ? (ms / 1000).toFixed(2) : '';
                    metaEl.textContent = seconds ? `${lastTotalResults} ürün · ${seconds}s` : `${lastTotalResults} ürün`;
                }

                const searchTimeEl = document.getElementById('search-time');
                if (searchTimeEl) {
                    const ms = Number(result.response_time_ms || 0);
                    searchTimeEl.textContent = ms ? `${ms}ms` : '0ms';
                }

                if (!(opts && opts.skipSave === true)) {
                    saveLastSearchState();
                }
                
            } catch (error) {
                console.error('❌ Akıllı arama hatası:', error);
                try {
                    await performFallbackSearch(searchTerm);
                } catch (e) {
                    showToast('Arama geçici olarak kullanılamıyor', 'error');
                }
                
            } finally {
                hideLoading();
            }
        }

        function renderPaginationMeta() {
            const el = document.getElementById('pagination-meta');
            if (!el) return;

            const total = Number(lastTotalResults || 0);
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const pageNum = Math.min(totalPages, currentPage + 1);

            const prevDisabled = currentPage <= 0 ? 'disabled' : '';
            const nextDisabled = (currentPage + 1) >= totalPages ? 'disabled' : '';

            el.innerHTML = `
                <button type="button" class="btn-secondary" id="page-prev" ${prevDisabled}>Önceki</button>
                <span style="font-weight:800; color:#0f172a;">Sayfa ${pageNum} / ${totalPages}</span>
                <button type="button" class="btn-secondary" id="page-next" ${nextDisabled}>Sonraki</button>
            `;

            const prevBtn = document.getElementById('page-prev');
            const nextBtn = document.getElementById('page-next');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage <= 0) return;
                    currentPage -= 1;
                    saveLastSearchState();
                    performSearch();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if ((currentPage + 1) >= totalPages) return;
                    currentPage += 1;
                    saveLastSearchState();
                    performSearch();
                });
            }
        }

        async function performFallbackSearch(searchTerm) {
            console.log('🔄 Fallback arama başlatılıyor:', searchTerm);
            
            try {
                const response = await fetch(`/api/b2b/products/search?q=${encodeURIComponent(searchTerm)}&customerCode=${currentUser.cari_kodu}`, {
                    headers: setAuthHeaders('customer')
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayFallbackResults(result, searchTerm);
                } else {
                    showToast('Arama geçici olarak kullanılamıyor', 'error');
                }
            } catch (error) {
                console.error('Fallback arama hatası:', error);
                showToast('Arama sistemi geçici olarak kullanılamıyor', 'error');
            }
        }

        function getSelectedOptions(selectEl) {
            if (!selectEl) return [];
            return Array.from(selectEl.selectedOptions || [])
                .map(o => String(o.value || '').trim())
                .filter(Boolean);
        }

        async function loadFilters() {
            try {
                if (!currentUser || !currentUser.cari_kodu) return;

                const response = await fetch(`/api/b2b/filters?customerCode=${encodeURIComponent(currentUser.cari_kodu)}`, {
                    headers: setAuthHeaders('customer')
                });
                if (!response.ok) {
                    throw new Error(`Filters API hatası: ${response.status}`);
                }
                
                const result = await response.json();
                if (!result || !result.success) {
                    throw new Error(result?.error || 'Filtre verisi alınamadı');
                }

                const manufacturers = Array.isArray(result.manufacturers) ? result.manufacturers : [];
                const vehicleModels = Array.isArray(result.vehicleModels) ? result.vehicleModels : [];

                manufacturersAll = manufacturers;
                vehicleModelsAll = vehicleModels;
                renderFilterLists();
                renderFilterChips();
            } catch (e) {
                console.error('Filtreler yüklenemedi:', e.message);
            }
        }

        function openFilterModal() {
            if (!filterModalBackdrop) return;
            filterModalBackdrop.style.display = 'flex';
            filterModalBackdrop.setAttribute('aria-hidden', 'false');
        }

        function closeFilterModal() {
            if (!filterModalBackdrop) return;
            filterModalBackdrop.style.display = 'none';
            filterModalBackdrop.setAttribute('aria-hidden', 'true');
        }

        function toggleInSelection(arr, value) {
            const v = String(value || '').trim();
            if (!v) return arr;
            const idx = arr.indexOf(v);
            if (idx >= 0) {
                return arr.filter(x => x !== v);
            }
            return [...arr, v];
        }

        function renderFilterLists() {
            const mQuery = (manufacturerSearchEl && manufacturerSearchEl.value) ? manufacturerSearchEl.value.trim().toLowerCase() : '';
            const vQuery = (vehicleSearchEl && vehicleSearchEl.value) ? vehicleSearchEl.value.trim().toLowerCase() : '';

            if (manufacturerListEl) {
                const list = (manufacturersAll || []).filter(v => !mQuery || String(v).toLowerCase().includes(mQuery));
                manufacturerListEl.innerHTML = list.map(v => {
                    const checked = selectedManufacturers.includes(v) ? 'checked' : '';
                    const id = `mchk_${safeDomId(v)}`;
                    return `
                        <label class="filter-item" for="${id}">
                            <input type="checkbox" id="${id}" value="${String(v).replace(/"/g, '&quot;')}" ${checked}>
                            <span class="label">${v}</span>
                        </label>
                    `;
                }).join('');
            }

            if (vehicleListEl) {
                const list = (vehicleModelsAll || []).filter(v => !vQuery || String(v).toLowerCase().includes(vQuery));
                vehicleListEl.innerHTML = list.map(v => {
                    const checked = selectedVehicleModels.includes(v) ? 'checked' : '';
                    const id = `vchk_${safeDomId(v)}`;
                    return `
                        <label class="filter-item" for="${id}">
                            <input type="checkbox" id="${id}" value="${String(v).replace(/"/g, '&quot;')}" ${checked}>
                            <span class="label">${v}</span>
                        </label>
                    `;
                }).join('');
            }

            if (manufacturerSelectedCountEl) manufacturerSelectedCountEl.textContent = String(selectedManufacturers.length);
            if (vehicleSelectedCountEl) vehicleSelectedCountEl.textContent = String(selectedVehicleModels.length);
        }

        function renderFilterChips() {
            if (!filterChipsEl) return;
            const chips = [];
            selectedManufacturers.forEach(v => chips.push({ type: 'm', value: v }));
            selectedVehicleModels.forEach(v => chips.push({ type: 'v', value: v }));
            filterChipsEl.innerHTML = chips.slice(0, 10).map(c => {
                const label = c.type === 'm' ? `Üretici: ${c.value}` : `Model: ${c.value}`;
                return `
                    <span class="filter-chip" data-type="${c.type}" data-value="${String(c.value).replace(/"/g, '&quot;')}">
                        ${label}
                        <button type="button" aria-label="Sil">×</button>
                    </span>
                `;
            }).join('');
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % 3;
            updateSlider();
        }

        function updateSlider() {
            slider.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            sliderDots.forEach((dot, index) => {
                if (index === currentSlide) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        function startSlider() {
            sliderInterval = setInterval(nextSlide, 5000);
        }

        function setupEventListeners() {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                performSearch();
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                    clearInterval(sliderInterval);
                    clearInterval(exchangeRatesInterval);
                    
                    localStorage.removeItem('b2b_cart');
                    localStorage.removeItem('b2b_user_data');
                    localStorage.removeItem('b2b_user_type');
                    localStorage.removeItem('b2b_session_id');
                    sessionStorage.clear();
                    
                    window.location.href = '/';
                }
            });

            sliderDots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    currentSlide = index;
                    updateSlider();
                    clearInterval(sliderInterval);
                    startSlider();
                });
            });

            const exchangeContainer = document.querySelector('.exchange-rates-container');
            if (exchangeContainer) {
                exchangeContainer.addEventListener('click', () => {
                    loadExchangeRates();
                    showNotification('Döviz kurları güncelleniyor...', 'info');
                });
            }

            if (openFiltersBtn) {
                openFiltersBtn.addEventListener('click', () => {
                    renderFilterLists();
                    openFilterModal();
                });
            }

            const clearAllFilters = (opts = {}) => {
                const hadAnyBefore = (selectedManufacturers && selectedManufacturers.length > 0) || (selectedVehicleModels && selectedVehicleModels.length > 0);
                selectedManufacturers = [];
                selectedVehicleModels = [];
                renderFilterLists();
                renderFilterChips();
                currentPage = 0;

                clearLastSearchState();

                const shouldRefresh = opts.force === true || !!(lastSearchTerm || '').trim() || hadAnyBefore;
                if (shouldRefresh) {
                    performSearch();
                }
            };

            if (quickClearFiltersBtn) {
                quickClearFiltersBtn.addEventListener('click', () => {
                    clearAllFilters();
                });
            }

            if (closeFiltersBtn) {
                closeFiltersBtn.addEventListener('click', () => {
                    closeFilterModal();
                });
            }

            if (filterModalBackdrop) {
                filterModalBackdrop.addEventListener('click', (e) => {
                    if (e.target === filterModalBackdrop) {
                        closeFilterModal();
                    }
                });
            }

            if (manufacturerSearchEl) {
                manufacturerSearchEl.addEventListener('input', () => {
                    renderFilterLists();
                });
            }

            if (vehicleSearchEl) {
                vehicleSearchEl.addEventListener('input', () => {
                    renderFilterLists();
                });
            }

            if (manufacturerListEl) {
                manufacturerListEl.addEventListener('change', (e) => {
                    const t = e.target;
                    if (t && t.matches && t.matches('input[type="checkbox"]')) {
                        selectedManufacturers = toggleInSelection(selectedManufacturers, t.value);
                        renderFilterLists();
                        renderFilterChips();
                    }
                });
            }

            if (vehicleListEl) {
                vehicleListEl.addEventListener('change', (e) => {
                    const t = e.target;
                    if (t && t.matches && t.matches('input[type="checkbox"]')) {
                        selectedVehicleModels = toggleInSelection(selectedVehicleModels, t.value);
                        renderFilterLists();
                        renderFilterChips();
                    }
                });
            }

            if (filterChipsEl) {
                filterChipsEl.addEventListener('click', (e) => {
                    const btn = e.target && e.target.closest ? e.target.closest('button') : null;
                    if (!btn) return;
                    const chip = btn.closest('.filter-chip');
                    if (!chip) return;
                    const type = chip.getAttribute('data-type');
                    const value = chip.getAttribute('data-value');
                    if (type === 'm') {
                        selectedManufacturers = selectedManufacturers.filter(x => x !== value);
                    } else {
                        selectedVehicleModels = selectedVehicleModels.filter(x => x !== value);
                    }
                    renderFilterLists();
                    renderFilterChips();
                    const hasAnyFilter = (selectedManufacturers && selectedManufacturers.length > 0) || (selectedVehicleModels && selectedVehicleModels.length > 0);
                    if ((lastSearchTerm || '').trim() || hasAnyFilter) {
                        currentPage = 0;
                        performSearch();
                    }
                });
            }

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    clearAllFilters();
                });
            }

            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    closeFilterModal();
                    const hasAnyFilter = (selectedManufacturers && selectedManufacturers.length > 0) || (selectedVehicleModels && selectedVehicleModels.length > 0);
                    if ((lastSearchTerm || '').trim() || hasAnyFilter) {
                        currentPage = 0;
                        performSearch();
                    }
                });
            }

            const syncCartFromStorage = () => {
                try {
                    updateCartCount();
                    updateAllItemCounts();
                } catch (e) {
                }
            };

            try {
                const cartChannel = new BroadcastChannel('b2b_cart_channel');
                cartChannel.addEventListener('message', (e) => {
                    if (e && e.data && e.data.type === 'cart_updated') {
                        syncCartFromStorage();
                    }
                });
            } catch (e) {
            }

            window.addEventListener('storage', (e) => {
                if (e && e.key === 'b2b_cart') {
                    syncCartFromStorage();
                }
            });

            window.addEventListener('focus', () => {
                syncCartFromStorage();
            });

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    syncCartFromStorage();
                }
            });

            window.addEventListener('pageshow', () => {
                syncCartFromStorage();

                restoreLastResultsButClearFilters();
            });

            window.addEventListener('beforeunload', (e) => {
                clearInterval(sliderInterval);
                clearInterval(exchangeRatesInterval);
            });
        }

        function filterProducts() {
        }

        async function loadExchangeRates() {
            try {
                console.log('💱 TCMB döviz kurları yükleniyor...');
                
                const response = await fetch('/api/exchange-rates');
                const result = await response.json();
                
                if (result.success) {
                    tcmbRates.EUR = result.data.EUR?.ForexBuying || 49.45;
                    tcmbRates.USD = result.data.USD?.ForexBuying || 42.43;
                    
                    const formattedEurRate = tcmbRates.EUR.toFixed(2).replace('.', ',');
                    const formattedUsdRate = tcmbRates.USD.toFixed(2).replace('.', ',');
                    
                    displayExchangeRates(formattedEurRate, formattedUsdRate, result.source);
                    
                    console.log(`✅ TCMB kurları yüklendi: EUR=${tcmbRates.EUR}, USD=${tcmbRates.USD}`);
                    
                } else {
                    throw new Error('TCMB verileri alınamadı');
                }
            } catch (error) {
                console.error('❌ TCMB kurları yüklenemedi:', error);
                displayExchangeRates('49,45', '42,43', 'Varsayılan');
            }
        }

        function startExchangeRatesAutoUpdate() {
            exchangeRatesInterval = setInterval(() => {
                loadExchangeRates();
            }, 5 * 60 * 1000);
            
            console.log('🔄 Döviz kurları otomatik güncelleme başlatıldı (5 dakika)');
        }

        function displayExchangeRates(eurRate, usdRate, source = 'TCMB') {
            if (eurRateEl) eurRateEl.textContent = eurRate;
            if (usdRateEl) usdRateEl.textContent = usdRate;
            if (tcmbSourceEl) {
                const timestamp = new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                tcmbSourceEl.textContent = `${source} - Son Güncelleme: ${timestamp}`;
            }
        }

        function showNotification(message, type = 'success') {
            const notificationText = document.getElementById('notification-text');
            notificationText.textContent = message;
            
            if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, var(--danger), #dc2626)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, var(--warning), #d97706)';
            } else if (type === 'info') {
                notification.style.background = 'linear-gradient(135deg, var(--info), #1d4ed8)';
            } else {
                notification.style.background = 'linear-gradient(135deg, var(--success), var(--success-dark))';
            }
            
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function showError(message) {
            productsTableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>${message}</div>
                    </td>
                </tr>
            `;
        }

        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                `;
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#4CAF50'};
                color: white;
                padding: 12px 20px;
                margin-bottom: 10px;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        function showLoading(opts = {}) {
            if (opts && opts.silent === true) {
                return;
            }
            let loadingContainer = document.getElementById('loading-container');
            if (!loadingContainer) {
                loadingContainer = document.createElement('div');
                loadingContainer.id = 'loading-container';
                loadingContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 255, 255, 0.8);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 9998;
                `;
                loadingContainer.innerHTML = `
                    <div style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "></div>
                `;
                document.body.appendChild(loadingContainer);
            }
            
            loadingContainer.style.display = 'flex';
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('loading-container');
            if (loadingContainer) {
                loadingContainer.style.display = 'none';
            }
        }
    </script>
</body>
</html>